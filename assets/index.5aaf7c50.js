var Oe=Object.defineProperty,Be=Object.defineProperties;var je=Object.getOwnPropertyDescriptors;var Y=Object.getOwnPropertySymbols;var pe=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var te=(d,e,n)=>e in d?Oe(d,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):d[e]=n,O=(d,e)=>{for(var n in e||(e={}))pe.call(e,n)&&te(d,n,e[n]);if(Y)for(var n of Y(e))ve.call(e,n)&&te(d,n,e[n]);return d},$=(d,e)=>Be(d,je(e));var Z=(d,e)=>{var n={};for(var a in d)pe.call(d,a)&&e.indexOf(a)<0&&(n[a]=d[a]);if(d!=null&&Y)for(var a of Y(d))e.indexOf(a)<0&&ve.call(d,a)&&(n[a]=d[a]);return n};var B=(d,e,n)=>(te(d,typeof e!="symbol"?e+"":e,n),n);import{v as Ee,r as Ae,c as ae,w as Ke,o as ne,K as _e,a as $e,b as H,d as p,e as ge,t as V,f as S,i as se,g as A,h as U,m as G,l as Ve,T as fe,j as me,k as re,n as Ie,M as qe,p as oe,q as Q,s as be,u as we,x as z,F as ie,y as ye,z as Le,A as He,B as W,C as Ue,D as ze,E as We}from"./vendor.ddf52c42.js";const Je=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))a(c);new MutationObserver(c=>{for(const i of c)if(i.type==="childList")for(const h of i.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&a(h)}).observe(document,{childList:!0,subtree:!0});function n(c){const i={};return c.integrity&&(i.integrity=c.integrity),c.referrerpolicy&&(i.referrerPolicy=c.referrerpolicy),c.crossorigin==="use-credentials"?i.credentials="include":c.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(c){if(c.ep)return;c.ep=!0;const i=n(c);fetch(c.href,i)}};Je();function Xe(d={}){const{immediate:e=!1,onNeedRefresh:n,onOfflineReady:a,onRegistered:c,onRegisterError:i}=d;let h;const l=async(m=!0)=>{};return"serviceWorker"in navigator&&(h=new Ee("/sw.js",{scope:"/",type:"classic"}),h.addEventListener("activated",m=>{m.isUpdate?window.location.reload():a==null||a()}),h.register({immediate:e}).then(m=>{c==null||c(m)}).catch(m=>{i==null||i(m)})),l}var Ye=(d,e)=>{const n=d.__vccOpts||d;for(const[a,c]of e)n[a]=c;return n};const Ze={};function Ge(d,e){const n=Ae("router-view");return ne(),ae(n,null,{default:Ke(({Component:a})=>[(ne(),ae(_e,null,[(ne(),ae($e(a)))],1024))]),_:1})}var Qe=Ye(Ze,[["render",Ge]]);class et{constructor(e){B(this,"idbDataBase",null);B(this,"transaction",null);B(this,"request",null);B(this,"runner",[]);B(this,"storeList",[]);B(this,"finish",null);B(this,"libName","");B(this,"operateLib",null);this.init(e)}init(i){var h=i,{dbName:e="waterMelon",dbVersion:n="1",storeList:a=[]}=h,c=Z(h,["dbName","dbVersion","storeList"]);this.dbName=e,this.idbDataBase&&this.idbDataBase.close(),this.finish=new Promise((l,m)=>{const I=r=>{const f=r.target.result;this.idbDataBase=f,this.dbVersion=f.version,this.idbObjectStoreNames=f.objectStoreNames,window.dataBase=f,this.transaction=this.idbDataBase.transaction.bind(this.idbDataBase),l(f)},C=r=>{I(r);const f=[];a.forEach(P=>{var T=P,{index:D}=T,M=Z(T,["index"]);let o=null;f.push(M.storeName),this.idbObjectStoreNames.contains(M.storeName)?o=this.request.transaction.objectStore(M.storeName):o=this.idbDataBase.createObjectStore(M.storeName,O({keyPath:"id",autoIncrement:!0},M)),[...o.indexNames].forEach(u=>o.deleteIndex(u)),D.forEach(u=>{let[s,L="false"]=u.split(":");s=s.trim(),L=L.trim(),o.createIndex(s,s,{unique:L!=="false"})})}),[...this.idbDataBase.objectStoreNames].forEach(D=>{f.includes(D)||this.idbDataBase.deleteObjectStore(D)})},v=indexedDB.open(e,n);v.onupgradeneeded=r=>C(r),v.onsuccess=r=>I(r),v.onerror=m,this.request=v})}close(){this.idbDataBase&&this.idbDataBase.close()}getLib(e){const n=Object.create(this);return n.libName=e,n}dealRequest(e,...n){return new Promise((a,c)=>{this.finish.then(()=>{const h=this.transaction(this.libName,"readwrite").objectStore(this.libName)[e](...n);if(h.toString()==="[object IDBIndex]"){a(h);return}h.onsuccess=l=>a(l.target.result),h.onerror=c})})}get(e){return this.dealRequest("get",e)}getAll(e){return this.dealRequest("getAll",e)}add(e){return this.dealRequest("add",$(O({},e),{create:Date.now()}))}async update(e){const n=await this.get(e.id);return this.dealRequest("put",$(O(O({},n),e),{update:Date.now()}))}delete(e){return this.dealRequest("delete",e)}find(e,n="content"){return new Promise(async(a,c)=>{const i=[],h=await this.dealRequest("index",n);if(!e){h.getAll().onsuccess=m=>a(m.target.result);return}const l=IDBKeyRange.only(e);h.openCursor(l).onsuccess=m=>{const I=m.target.result;if(!I)return a(i);i.push(I.value),I.continue()}})}query(e,n="content"){return new Promise(async(a,c)=>{try{const i=await this.dealRequest("index",n);i.getAll().onsuccess=h=>{const l=h.target.result;if(!e)return a(l);const m=e.split(" ").filter(C=>C),I=l.filter(C=>{const v=C[n]+"";for(let F=0;F<m.length;F++)if(!v.includes(m[F]))return!1;let r=new RegExp(`(.{0,10})(${m.reverse().join("|")})(.{0,10})`,"g");const f=v.replace(r,'$%$1<span class="searchHight">$2</span>$3%$').match(/(?<=\$%)(.*?)(?=%\$)/g,"$1");return C.__searchResult=f,!0});a(I)}}catch(i){console.error(i),a([])}})}}const ce=["create","update"],tt={storeName:"atom",index:[...ce,"title:false","content","describe","type","area","target","tag","history","extra"]},at={storeName:"relation",index:[...ce,"childId","parentId","relation","target","area"]},nt={storeName:"tag",index:[...ce,"atomId","title","content","describe","color","type","target"]},st={dbName:"waterMelon",dbVersion:4,storeList:[tt,at,nt]};var Fe=new et(st);class rt{constructor(){B(this,"_finish",null);B(this,"dbList",["atom","tag","relation"]);B(this,"data",H({atom:[],tag:[],relation:[],currentItem:{}}));B(this,"dbItem",{atom:null,tag:null,relation:null});this.initDb(),this._finish=this.init()}async initDb(){for(let e in this.dbItem)this.dbItem[e]=await Fe.getLib(e)}async init(e="atom"){if(e){const a=await Fe.getLib(e).getAll();return this.data[e]=a}const n=await Promise.all(this.dbList.map(a=>this.dbList[a].getAll()));return this.dbList.forEach((a,c)=>this.data[a]=n[c]),n}async atomFetch(e,...n){const a=await this.dbItem.atom[e](...n);return await this.init("atom"),a}async tagFetch(e,...n){const a=await this.dbItem.tag[e](...n);return await this.init("tag"),a}async relationFetch(e,...n){const a=await this.dbItem.relation[e](...n);return await this.init("relation"),a}changeData(e,n){this.data[e]&&(this.data[e]=n)}}const xe=new rt;window.libFetch=xe;var ot={emits:["mousedownFnc"],setup(d,{emit:e,slots:n}){return()=>p("div",{class:"dragPanel",onSelect:()=>!1,onMousedown:ge(a=>e("mousedownFnc",a),["self"])},[n.default&&n.default()])}},Se={props:{area:Object,layer:Number,fullScreen:{type:Boolean,default:!1}},emits:["changeTile"],setup(d,{slots:e,emit:n,expose:a}){const{area:c,layer:i,fullScreen:h}=V(d),l=H({top:0,left:0,width:0,height:0});i.value=i.value||0;const m=(y,w)=>{const x=0,k=10,K=window.innerWidth-l.width,q=window.innerHeight-l.height||k;l.left=Math.max(x,Math.min(K,y)),l.top=Math.min(q,Math.max(k,w))},I=()=>{var y,w,x,k;l.width=((y=c.value)==null?void 0:y.width)||r.value&&r.value.getBoundingClientRect().width||0,l.height=((w=c.value)==null?void 0:w.height)||r.value&&r.value.getBoundingClientRect().height||0,m(((x=c.value)==null?void 0:x.left)||0,Math.max(((k=c.value)==null?void 0:k.top)||0,14))},C=S(!1);C.value=h.value;const v=S(!1),r=S(null),f=S(null),F=S(0),D=S(0),M=S(0),P=se("zIndex"),T=se("upperLayer");M.value=P.value;const o=()=>{T(),M.value=P.value},R=(y,w)=>{if(C.value){C.value=!1,v.value=!1;return}if(v.value=!0,!r.value)return;const{left:x,top:k}=r.value.getBoundingClientRect();F.value=y.clientX-x,D.value=y.clientY-k,o()},u=y=>v.value=!1,s=y=>{if(!v.value)return;let w=y.clientX-F.value,x=y.clientY-D.value;m(w,x)},L=y=>C.value=!C.value;return I(),A(()=>l,y=>{C.value||n("changeTile",y)},{deep:!0}),A(()=>c.value,I,{deep:!0}),U(()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",u),document.addEventListener("mousemove",s),document.addEventListener("mouseup",u),new ResizeObserver(w=>{let{width:x,height:k}=w[0].contentRect;x===0||k===0||C.value||(Math.abs(x-l.width)>2||Math.abs(k-l.height)>2)&&(l.width=x,l.height=k)}).observe(f.value)}),a({changeScreen:L,changeIndex:o}),()=>p("div",{ref:r,style:{left:l.left+"px",top:l.top+"px","z-index":M.value},class:{tile:!0,fullScreen:!!C.value}},[p(ot,{onMousedownFnc:R},{default:()=>[e.header&&e.header(l,{changeIndex:o,changeScreen:L,isFull:C,isHandler:v})]}),p("div",{ref:f},[e.default&&e.default(l,{changeIndex:o,isFull:C,isHandler:v})]),e.footer&&e.footer(l,{changeIndex:o})])}};G.setOptions({gfm:!0,tables:!0,breaks:!0,katex:!1,headerIds:!0,headerPrefix:"",highlight:function(d,e){const n=e?[e]:null;return Ve.highlightAuto(d,n).value}});const it={checkbox(d,...e){return window.changeChecked=n=>{n.checked?n.setAttribute("checked","checked"):n.removeAttribute("checked")},`<input type="checkbox" ${d?"checked disabled":""} onChange="changeChecked(this)" /> `}};G.use({renderer:it});const le=new fe({headingStyle:"atx",codeBlockStyle:"fenced",bulletListMarker:"-",fence:"```",preformattedCode:!0});fe.prototype.escape=d=>[[/\\/g,"\\\\"],[/\*/g,"\\*"],[/^\+ /g,"\\+ "],[/^(#{1,6}) /g,"\\$1 "],[/`/g,"\\`"],[/^~~~/g,"\\~~~"],[/^>/g,"\\>"],[/^_/g,"\\_"],[/^(\d+)\. /g,"$1\\. "]].reduce((n,a)=>n.replace(a[0],a[1]),d);le.addRule("content_rule",{filter:["input"],replacement:(d,e,n)=>e.type==="checkbox"?e.checked?"[x]":"[ ]":d});const Ce=le.turndown.bind(le),ct=d=>{const e=d.clipboardData.getData("text/html"),n=d.clipboardData.getData("text/plain"),c=window.getSelection().getRangeAt(0);c.deleteContents(),c.startContainer,c.startOffset;const i=G(Ce(e||n)),h=document.createElement("div");h.innerHTML=i,c.insertNode(h)};var lt={props:{content:String,viewSeat:Object,isFocus:{type:Boolean,default:!1},editAble:{type:Boolean,default:!1}},emits:["blurfnc","update:content"],setup(d,e){const{content:n,viewSeat:a,editAble:c,isFocus:i}=V(d),{emit:h}=e,l=S("view"),m=()=>{l.value&&h("blurfnc",{content:l.value.innerHTML},"view")},I=()=>{!l.value||(a.value.width&&(l.value.style.width=a.value.width+"px"),a.value.height&&(l.value.style.height=a.value.height+"px"))};return U(()=>{!l.value||(I(),i.value&&l.value.focus())}),me(m),()=>p("div",{ref:l,class:"view",contentEditable:c.value,innerHTML:n.value,onBlur:m,onSelect:()=>!1,onPaste:ge(ct,["stop","prevent"])},null)}};const ut={theme:"vs-dark",roundedSelection:!0,automaticLayout:!0,autoDetectHighContrast:!0,contextmenu:!0,lineNumbers:!1,droppable:!0,fontSize:15,fontFamily:'consolas, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif',format:!0,formatOnType:!0,formatOnPaste:!0,autoIndent:!0,folding:!0,wordWrap:!0,language:"markdown",charset:"UTF-8",unicodeHighlight:{invisibleCharacters:!1,ambiguousCharacters:!1},minimap:{enabled:!1}},dt=[{label:"bbb",kind:re.CompletionItemKind.Tag,insertText:"\u9009\u62E9\u540E\u7C98\u8D34\u5230\u7F16\u8F91\u5668\u4E2D\u7684\u6587\u5B57",detail:"\u4EFB\u4F55\u6587\u5B57\u63D0\u793A",preselect:!0},{label:"aaa",kind:re.CompletionItemKind.Function,insertText:"aaa",detail:"\u4EFB\u4F55\u6587\u5B57\u63D0\u793A123"}];re.registerCompletionItemProvider("markdown",{autoIndent:!0,triggerCharacters:["#"],provideCompletionItems(d,e,...n){let a=[];return d.getWordAtPosition(e),window.mo=d,a=d.getLineContent(e.lineNumber).slice(e.column-2).startsWith("#")?[...dt]:[],{suggestions:JSON.parse(JSON.stringify(a))}}});class ht{constructor(e,{blur:n}){B(this,"monaco",null);const a=Ie.create(e,ut);return a.editor=Ie,a.onDidBlurEditorWidget(n),new qe().activate(a),a}}var pt={props:{content:String,viewSeat:Object,metaData:Object},emits:["blurfnc","update:content"],setup(d,e){const{content:n,viewSeat:a,metaData:c}=V(d),{emit:i}=e,h=S("editor");let l=null;const m=()=>{if(!l)return;const v=l.getValue()||"",r=/===\n([\s\S]*)\n===\n/g.exec(v)&&/===\n([\s\S]*)\n===\n/g.exec(v)[1],f=v.replace(/===\n([\s\S]*)\n===\n/g,"");let F=/title:(.*)\n/.exec(r)&&/title: (.*)\n/.exec(r)[1];const D=/describe:(.*)\n|describe:(.*)$/.exec(r),M=D&&(D[2]||D[1]),P=/^[\s\n\r]*#{1,}\s(.*)\n/.exec(f);return F=P&&P[1]||F,{content:f,metaData:{title:F.trim(),describe:M.trim()}}},I=()=>{console.dir(123),i("blurfnc",m(),"editor")},C=()=>{h.value.style.width=a.value.width+"px",h.value.style.height=a.value.height+"px"};return U(()=>{C(),l=new ht(h.value,{blur:I}),console.dir(c.value);const v=`===
 title: ${c.value.title}
 describe: ${c.value.describe}
===
${n.value}`;l.setValue(v),l.focus()}),me(I),()=>p("div",{class:"editor",ref:h},null)}},vt={props:["itemInfo","itemIndex","layer","viewModel","isFocus","isActive","pageItem"],emits:["deleteItem","add","changeLayer","changeCurrent","changePage","hide","mark"],setup(d,{emit:e,expose:n}){const a=S(null),{itemInfo:c,itemIndex:i,layer:h,viewModel:l,isFocus:m,isActive:I,pageItem:C}=V(d),v=S(""),r=S(!1),f=S({title:"",describe:""});r.value=m.value,console.dir(c.value),v.value=c.value.content||"",f.value.title=c.value.title||"",f.value.describe=c.value.describe||"";const F=S(!0);F.value=l.value;const D=S({}),M=oe(()=>G(v.value)),P=oe(()=>v.value),T=(s,L,y)=>{let w=L==="view"?Ce(s.content):s.content;if(w=w.replace(/[-]\s{2,}/g,"- "),w=w.trim(),!v.value&&!w&&!c.value.id){if(y)return;e("deleteItem",i.value)}debugger;v.value=w,f.value=s.metaData||f.value},o=s=>a.value&&a.value.changeScreen(s),R=s=>a.value&&a.value.changeIndex(),u=s=>{D.value=s,e("changeLayer",{area:s,content:v.value},i.value)};return A(()=>v.value,s=>{console.dir(s),e("add",$(O({content:s},f.value),{area:O(O({},c.value.area),D.value)}),i.value)}),n({triggleView:s=>{F.value=!F.value,r.value=!0},changeScreen:o,changeIndex:R,isView:F}),()=>p(Se,{ref:a,area:c.value.area,layer:h.value,class:$(O({},c.value.options),{active:I.value}),onMouseup:s=>s.target.className.includes("dragPanel")&&e("changeCurrent",-1),onMousedown:()=>e("changeCurrent",i.value),onChangeTile:u},{header:()=>{var s,L;return p("span",{class:"toolPanel"},[!((L=(s=c.value)==null?void 0:s.options)==null?void 0:L.searchLink)&&p("span",{class:"tool pin",title:"Pin Up",onClick:y=>e("hide",i.value,"pin")},null),p("span",{class:"tool mark",title:"Mark It",onClick:y=>e("mark",i.value)},null),p("span",{class:"tool hide",title:"Hide It",onClick:y=>e("hide",i.value,"hide")},null)])},default:(s,{isFull:L,isHandler:y,changeIndex:w})=>p("div",{style:"positon: relative;"},[p("span",{class:{cardBefore:!0,active:I.value},onClick:x=>e("changePage",i.value)},[c.value.id]),F.value?p(lt,{class:{fullScreen:L.value},content:M.value,"onUpdate:content":x=>M.value=x,viewSeat:s,isFocus:r.value,onBlurfnc:(...x)=>T(...x,y.value),onMousedown:w,editAble:!0},null):p(pt,{class:{fullScreen:L.value},content:P.value,"onUpdate:content":x=>P.value=x,viewSeat:s,onMousedown:w,editAble:!0,metaData:f.value,onBlurfnc:(...x)=>T(...x,y.value)},null)])})}};var gt={name:"Search",props:["area","isShow"],setup(d,{emit:e}){const a=Q().appContext.config.globalProperties.$libFetch,c=a.data;window.libData=c;const{isShow:i,area:h}=V(d),l=S(""),m=S(null),I=S([]),C=async(v,{self:r,current:f})=>{if(r||f)return;const F=await a.atomFetch("get",v);F&&e("insertFnc",F),l.value="",i.value=!1};return U(()=>{document.addEventListener("keydown",v=>{v.code==="Escape"&&i.value&&(l.value="",i.value=!1)})}),A(()=>i.value,v=>{v&&setTimeout(()=>{m.value.focus()},50)}),A(()=>l.value,async v=>{const r={t:"title",c:"content",d:"describe"};let[f="",F="content",D="atom"]=v.trim().split("|");if(f=f.trim(),F=F.trim(),F=r[F]||F,!f)return I.value=[];I.value=await a[D+"Fetch"]("query",f,F)||[],console.dir(f),console.dir(F),console.dir(I.value),console.dir("--------------------")}),()=>p(Se,{style:{display:i.value?"block":"none"},area:h.value},{default:v=>p("div",{class:"searchPanel"},[be(p("input",{ref:m,type:"text",class:"searchIcon","onUpdate:modelValue":r=>l.value=r},null),[[we,l.value]]),p("div",{class:"searchResult"},[I.value.map(r=>{const f=r.id===c.currentItem.id,F=r.parentIds&&r.parentIds.includes(`%${c.currentItem.id}$`);return p("div",{class:"searchItem",onClick:()=>C(r.id,{self:f,current:F})},[p("div",{class:"itemHeader"},[p("div",{class:{light:!0,current:F,self:f}},[z("\xA0")]),p("div",null,[p("div",null,[r.title||r.content.substr(0,18)])])])])})])])})}};var ft={props:["menuList","activeIndex","isShow"],emits:["showCard"],setup(d,{emit:e}){const{menuList:n,activeIndex:a,isShow:c}=V(d),i=h=>{};return()=>p("div",{class:{menuPanel:!0,showMenu:c.value}},[p("div",{class:"parent",onClick:i},[p("span",null,[z("...")])]),n.value.map((h,l)=>{var m;return p("div",{onClick:I=>e("showCard",l),class:{searchLink:!!((m=h==null?void 0:h.options)==null?void 0:m.searchLink),active:a.value===l,hide:h.target===".hide"}},[p("span",null,[h.id])])})])}};var mt={props:["toPanel","currentItem"],emits:["hideInsert","insert"],setup(d,{expose:e,emit:n}){const{toPanel:a,currentItem:c}=V(d),h=Q().appContext.config.globalProperties.$libFetch,l=S(null),m=S(null),I=S(""),C=S(!1),v=S([]),r=S([]),f=H({left:0,top:0,width:300,height:300}),F=o=>{I.value="",v.value=[],C.value=!1,n("hideInsert")},D=async o=>{if(o.key==="Escape")return F();if(o.code==="Enter"&&o.altKey){const R=a.value==="tag"?"tagFetch":"atomFetch",u=I.value.trim(),s=await h[R]("add",{content:u,title:u}),L=await h[R]("get",s-0);n("insert",L)}},M=async(o,R)=>{n("insert",R)},P=()=>{const{left:o}=l.value.getBoundingClientRect(),{height:R}=m.value.getBoundingClientRect();f.left=o,f.top=window.innerHeight-25-R,console.dir(f.top)},T=async()=>{I.value="",setTimeout(()=>{l.value&&l.value.focus()},50);const o=a.value==="tag"?"tagFetch":"atomFetch",R=await h[o]("getAll");r.value=R,v.value=R,setTimeout(()=>{P()},50),C.value=!0};return U(()=>{T()}),A(()=>a.value,T),A(()=>I.value,async o=>{const R={t:"title",c:"content",d:"describe"},u=a.value==="tag"?"tagFetch":"atomFetch";let[s="",L="c"]=o.split("|");if(s=s.trim(),L=L.trim(),L=R[L]||"content",s)if(isNaN(s-0))v.value=r.value.filter(w=>w[L].includes(s));else{const w=await h[u]("get",s-0);v.value=w?[w]:[]}else v.value=r.value;setTimeout(()=>{P()},50),C.value=!!v.value.length}),()=>p(ie,null,[p(ye,{to:"#"+a.value},{default:()=>[be(p("input",{ref:l,type:"text",class:"suggestInput","onUpdate:modelValue":o=>I.value=o,onKeyup:D},null),[[we,I.value]])]}),p(ye,{to:"body"},{default:()=>[p("div",{ref:m,class:{suggestResult:!0,showResult:C.value},style:{left:f.left+"px",top:f.top+"px"}},[p("div",null,[v.value.map(o=>p("div",{onClick:R=>M(R,o),title:o.content},[o.title||o.describe||o.content.slice(0,10),z(" - "),o.id]))])])]})])}},It={name:"Tape",props:{pageData:{type:Object,default(){return{}}},currentIndex:{type:Number,default:0}},setup(d,{expose:e}){const n=Le(),{pageData:a,currentIndex:c}=V(d),h=Q().appContext.config.globalProperties.$libFetch,l=async u=>h.atomFetch("get",u),m=S(null),I=S(!1),C=S(""),v=S({}),r=H({id:"",title:"",describe:"",parentIds:[],childIds:[],tagList:[],parentIdMap:{},childIdMap:{}}),f=se("insertCard"),F=oe(()=>{const u=r.id,s=r.title||r.describe||"";return s?u+"_"+s:u}),D=()=>{I.value=!1,C.value=""},M=(u,s)=>{u.target.className.includes("metaItem")||C.value!==s&&(I.value=!0,C.value=s)},P=()=>{r.id="",r.parentIds=[],r.childIds=[],r.tagList=[],r.parentIdMap={},r.childIdMap={}},T=async()=>{const u=a.value.pageList[c.value]||a.value.currentItem;v.value=u;const{id:s}=u;if(!s)return;P(),r.id=s;const[L,y,w,x]=await Promise.all([h.relationFetch("find",s,"parentId"),h.relationFetch("find",s,"childId"),h.tagFetch("getAll"),h.atomFetch("get",s)]);r.title=x.title,r.describe=x.describe,w.forEach(k=>{k.atomId&&k.atomId.includes(s)&&r.tagList.push(k)}),y.forEach(async k=>{const K=k.parentId,q=await l(K);r.parentIdMap[k.parentId]=k.id,r.parentIds.push({id:K,item:k,atom:q})}),L.map(async k=>{const K=k.childId;r.childIdMap[k.childId]=k.id;const q=await l(K);r.childIds.push({id:K,item:k,atom:q})})},o=async u=>{const s=v.value.id,L=u.id-0;if(s===L)return;const y=C.value;if(y==="tag"){const w=await h.tagFetch("get",L),x=w.atomId||[];if(x.includes(s))return;x.push(s);const k=$(O({},w),{atomId:x});await h.tagFetch("update",k),r.tagList.push(k)}else{const w=y==="parent"?"childId":"parentId";if(r[y+"IdMap"][L])return;const x={[w]:s,[y+"Id"]:L};await h.relationFetch("add",x),r[y+"Ids"].push({id:L,item:x,atom:u}),r[y+"IdMap"][L]=s}D()},R=async(u,s,L)=>{const y=v.value.id;let w;if(u.ctrlKey&&u.shiftKey){if(L==="tag"){w=s.id;const k=(s.atomId||[]).filter(K=>K!==y);await h.tagFetch("update",{id:w,atomId:k})}else w=s.item.id,await h.relationFetch("delete",w);return T()}else if(u.altKey){let x="";return s.atom&&(x+=s.atom.title?"#"+s.atom.title:"",x+=s.atom.describe?"#"+s.atom.describe:""),n.push({name:L==="tag"?"tag":"ov",params:{id:s.id},hash:x})}else u.ctrlKey&&f(s.atom);console.dir(u)};return A(()=>c.value,T),A(()=>a.value.currentItem.id,T),e({hideInsert:D}),()=>p(ie,null,[p("div",{id:"tape",class:"tape"},[p("div",{class:"info"},[p("span",{class:"metaInfo"},[p("span",null,[F.value])]),p("span",{id:"parent",onClick:u=>M(u,"parent")},[p("span",{class:"itemTitle"},[z("P")]),r.parentIds.map(u=>{const s=u.atom.title||u.atom.describe,L=s?"_"+s:"";return p("span",{class:{metaItem:!0,current:u.id===a.value.currentItem.id},title:u.atom.title||u.atom.describe||u.atom.content,onClick:y=>R(y,u)},[u.id+L])})]),p("span",{id:"child",onClick:u=>M(u,"child")},[p("span",{class:"itemTitle"},[z("C")]),r.childIds.map(u=>{const s=u.atom.title||u.atom.describe,L=s?"_"+s:"";return p("span",{class:{metaItem:!0,current:u.id===a.value.currentItem.id},title:u.atom.title||u.atom.describe||u.atom.content,onClick:y=>R(y,u)},[u.id+L])})]),p("span",{id:"tag",onClick:u=>M(u,"tag")},[p("span",{class:"itemTitle"},[z("T")]),r.tagList.map(u=>p("span",{class:{metaItem:!0},title:u.title||u.content,style:{color:u.color||""},onClick:s=>R(s,u,"tag")},[u.content||u.id]))])])]),I.value&&p(mt,{ref:m,onInsert:o,toPanel:C,currentItem:v,onHideInsert:D},null)])}},bt={setup(d,e){const n=He(),a=Le(),i=Q().appContext.config.globalProperties.$libFetch,h=i.data,l=H({}),m=S(0),I=S(-1),C=S(!0),v=S(null),r=S(!1),f=S(""),F=S(0),D=S(!0),M=S(!1),P=S(null),T=H({left:1e4,top:14,right:0,width:580,height:"auto",zIndex:9999}),o=H({currentItem:{},pageList:[],pageIdsList:{},atomList:[],relationItem:[]}),R=async(t,b)=>{const g=h.atom.find(_=>_.title===b);if(g)return g;const N=await i.atomFetch("add",{title:b,type:t,describe:b});return await i.atomFetch("get",N)},u=async t=>{if(await i._finish,t==="root"){const g=await R(".root",t);return o.currentItem=g}if(t-=0,isNaN(t))return;const b=h.atom.find(g=>g.id===t);if(!b)return a.push({name:"ov",params:{id:"root"},hash:"#root"});o.currentItem=b},s=t=>{const{id:b,title:g,describe:N}=o.pageList[t];let j=g?"#"+g:"";j+=N?"#"+N:"",b&&a.push({name:"ov",params:{id:b},hash:j})},L=()=>{o.pageList=o.atomList.filter(({target:t})=>t!==".del"),C.value=!0},y=async()=>{const t=o.currentItem;i.changeData("currentItem",t);const b=[],g=await i.relationFetch("find",t.id,"parentId");await Promise.all(g.map(async({childId:N="",area:j,target:_})=>{const E=await i.atomFetch("get",N);return b.push($(O({},E),{key:Math.random().toString(16),area:j,target:_,hide:_===".hide"})),E})),o.atomList=b,o.relationItem=g,L()},w=t=>I.value=t-0,x=(t,b)=>{const g=o.pageList.push($(O({key:Math.random().toString(16)},t),{options:b}));w(g-1)},k=t=>{const b=o.pageIdsList[t.id];if(b||b===0){w(b),o.pageList[b].hide=!1;return}x(O({},t),{searchLink:!0})},K=t=>{k(t),r.value=!1},q=(t={})=>r.value=!0,ke=t=>{t.target===t.currentTarget&&(P.value&&P.value.hideInsert(),w(-1),!!(t.ctrlKey||t.altKey)&&(t.preventDefault(),x({area:{left:t.pageX,top:t.pageY}},{isFocus:!0,ignoreParent:t.shiftKey}),C.value=t.ctrlKey))},de=async(t,b)=>{const g=o.pageList[b],_=g,{options:N={}}=_,j=Z(_,["options"]);if(j.id){if(await i.atomFetch("update",JSON.parse(JSON.stringify($(O({},t),{id:j.id})))),!N.searchLink){const E=o.relationItem.find(({childId:X})=>X===j.id);E&&await i.relationFetch("update",JSON.parse(JSON.stringify({id:E.id,area:t.area})))}}else{const E=await i.atomFetch("add",JSON.parse(JSON.stringify(t)));if(o.pageList[b].id=E,!(N==null?void 0:N.ignoreParent)){const X={childId:E,parentId:o.currentItem.id,area:t.area},Te=await i.relationFetch("add",X);o.relationItem.push(O({id:Te},X))}}g.content=t.content||g.content,g.area=t.area||g.area},ee=async t=>{await u(t),y()},De=async({area:t,content:b},g)=>{!o.pageList[g]||!o.pageList[g].id||de({area:t,content:b},g)},Me=()=>F.value=F.value+1,J=async(t,b)=>{const g=o.pageList.splice(t,1)[0];if(!(!g||!g.id))if(b)await i.atomFetch("update",{id:g.id,target:".del",delTime:Date.now()});else{await i.atomFetch("delete",g.id);const N=await i.relationFetch("find",g.id,"childId");[...await i.relationFetch("find",g.id,"parentId"),...N].forEach(({id:E})=>i.relationFetch("delete",E))}},Re=async t=>{const b=o.pageList[t];console.dir(b)},he=async(t,b)=>{var _;const g=o.pageList[t],N=g.target===".hide"?"":".hide";if(b==="hide")return((_=g==null?void 0:g.options)==null?void 0:_.searchLink)&&o.pageList.splice(t,1),g.hide=!0;const j=o.relationItem.find(E=>E.childId===g.id);await i.relationFetch("update",{id:j.id,target:N}),g.target=N,g.hide=N===".hide"},Ne=()=>{o.pageList.forEach(t=>{t.target!==".hide"&&(t.hide=D.value)}),D.value=!D.value},Pe=t=>{const b=o.pageList[t];w(t),b.hide=!1};return W("insertCard",k),W("refreshHash",f),W("refreshFnc",()=>f.value=Math.random().toString(16)),W("upperLayer",Me),W("zIndex",F),U(()=>{ee(n.params.id),document.onkeydown=t=>{const b=t.srcElement.localName==="body",g=I.value;if(b)return t.code==="KeyX"?window.close():t.code==="KeyP"?q():t.code==="KeyR"?ee(n.params.id):t.code==="KeyM"?M.value=!M.value:t.code==="KeyH"&&t.altKey?Ne():(t.code==="Minus"&&t.ctrlKey&&(t.preventDefault(),history.go(-1)),t.code==="Equal"&&t.ctrlKey&&(t.preventDefault(),history.go(1)),g===-1?void 0:t.altKey&&t.shiftKey&&t.code==="Delete"?J(g):t.altKey&&t.code==="Delete"?J(g,30):void 0);const N=l[g];if(N&&t.altKey&&t.code==="KeyV")return N.triggleView(t);if(N&&t.altKey&&t.code==="KeyZ")return N.changeScreen(t);if(t.altKey&&t.code==="KeyH")return he(g,"pin");if(t.altKey&&t.code==="Delete")return J(g)}}),A(()=>n.params.id,t=>t&&ee(t)),A(()=>o.pageList.length,t=>{o.pageIdsList=[],o.pageList.forEach((b,g)=>{o.pageIdsList[b.id]=g,m.value=Math.max(m.value,t)}),m.value=Math.max(m.value,t)},{deep:!0}),A(()=>I.value,t=>{const b=l[t];b&&b.changeIndex()}),()=>p(ie,null,[p(ft,{menuList:o.pageList,activeIndex:I.value,isShow:M.value,onShowCard:Pe},null),p("div",{style:"width: calc(100vw - 15px); height: calc(100vh);",ref:v,onclick:ke},[p(gt,{isShow:r,area:T,onInsertFnc:K},null),o.pageList.map((t,b)=>{var g;return!t.hide&&p(vt,{key:t.key,ref:N=>l[b]=N,viewModel:C,pageItem:o.currentItem,itemInfo:t,itemIndex:b,layer:m.value,isActive:I.value===b,isFocus:((g=t==null?void 0:t.options)==null?void 0:g.isFocus)||!1,onAdd:de,onChangeLayer:De,onChangeCurrent:w,onDeleteItem:J,onChangePage:s,onMark:Re,onHide:he},null)}),p(It,{ref:P,currentIndex:I,pageData:o},null)])])}};const wt=Ue({history:ze(),routes:[{name:"ov",path:"/ov/:id",component:bt},{path:"/:pathMatch(.*)*",redirect:"/ov/root"}]}),ue=We(Qe);ue.config.globalProperties.$libFetch=xe;ue.use(wt);ue.mount("#app");const yt=Xe({onNeedRefresh(){},onOfflineReady(){}});yt();
