var Ke=Object.defineProperty,Be=Object.defineProperties;var Ee=Object.getOwnPropertyDescriptors;var Y=Object.getOwnPropertySymbols;var pe=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var ae=(d,e,n)=>e in d?Ke(d,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):d[e]=n,O=(d,e)=>{for(var n in e||(e={}))pe.call(e,n)&&ae(d,n,e[n]);if(Y)for(var n of Y(e))ve.call(e,n)&&ae(d,n,e[n]);return d},_=(d,e)=>Be(d,Ee(e));var Z=(d,e)=>{var n={};for(var a in d)pe.call(d,a)&&e.indexOf(a)<0&&(n[a]=d[a]);if(d!=null&&Y)for(var a of Y(d))e.indexOf(a)<0&&ve.call(d,a)&&(n[a]=d[a]);return n};var K=(d,e,n)=>(ae(d,typeof e!="symbol"?e+"":e,n),n);import{v as Ae,r as je,c as ne,w as $e,o as se,K as _e,a as Ve,b as q,d as p,e as fe,t as V,f as C,i as re,g as A,h as U,m as G,l as He,T as ge,j as me,k as oe,n as Ie,M as qe,p as ie,q as Q,s as be,u as we,x as z,F as ce,y as ye,z as Le,A as Ue,B as W,C as ze,D as We,E as Je}from"./vendor.ddf52c42.js";const Xe=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))a(l);new MutationObserver(l=>{for(const i of l)if(i.type==="childList")for(const h of i.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&a(h)}).observe(document,{childList:!0,subtree:!0});function n(l){const i={};return l.integrity&&(i.integrity=l.integrity),l.referrerpolicy&&(i.referrerPolicy=l.referrerpolicy),l.crossorigin==="use-credentials"?i.credentials="include":l.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(l){if(l.ep)return;l.ep=!0;const i=n(l);fetch(l.href,i)}};Xe();function Ye(d={}){const{immediate:e=!1,onNeedRefresh:n,onOfflineReady:a,onRegistered:l,onRegisterError:i}=d;let h;const o=async(g=!0)=>{};return"serviceWorker"in navigator&&(h=new Ae("/sw.js",{scope:"/",type:"classic"}),h.addEventListener("activated",g=>{g.isUpdate?window.location.reload():a==null||a()}),h.register({immediate:e}).then(g=>{l==null||l(g)}).catch(g=>{i==null||i(g)})),o}var Ze=(d,e)=>{const n=d.__vccOpts||d;for(const[a,l]of e)n[a]=l;return n};const Ge={};function Qe(d,e){const n=je("router-view");return se(),ne(n,null,{default:$e(({Component:a})=>[(se(),ne(_e,null,[(se(),ne(Ve(a)))],1024))]),_:1})}var et=Ze(Ge,[["render",Qe]]);class tt{constructor(e){K(this,"idbDataBase",null);K(this,"transaction",null);K(this,"request",null);K(this,"runner",[]);K(this,"storeList",[]);K(this,"finish",null);K(this,"libName","");K(this,"operateLib",null);this.init(e)}init(i){var h=i,{dbName:e="waterMelon",dbVersion:n="1",storeList:a=[]}=h,l=Z(h,["dbName","dbVersion","storeList"]);this.dbName=e,this.idbDataBase&&this.idbDataBase.close(),this.finish=new Promise((o,g)=>{const I=c=>{const m=c.target.result;this.idbDataBase=m,this.dbVersion=m.version,this.idbObjectStoreNames=m.objectStoreNames,window.dataBase=m,this.transaction=this.idbDataBase.transaction.bind(this.idbDataBase),o(m)},w=c=>{I(c);const m=[];a.forEach(P=>{var T=P,{index:D}=T,M=Z(T,["index"]);let r=null;m.push(M.storeName),this.idbObjectStoreNames.contains(M.storeName)?r=this.request.transaction.objectStore(M.storeName):r=this.idbDataBase.createObjectStore(M.storeName,O({keyPath:"id",autoIncrement:!0},M)),[...r.indexNames].forEach(u=>r.deleteIndex(u)),D.forEach(u=>{let[s,F="false"]=u.split(":");s=s.trim(),F=F.trim(),r.createIndex(s,s,{unique:F!=="false"})})}),[...this.idbDataBase.objectStoreNames].forEach(D=>{m.includes(D)||this.idbDataBase.deleteObjectStore(D)})},v=indexedDB.open(e,n);v.onupgradeneeded=c=>w(c),v.onsuccess=c=>I(c),v.onerror=g,this.request=v})}close(){this.idbDataBase&&this.idbDataBase.close()}getLib(e){const n=Object.create(this);return n.libName=e,n}dealRequest(e,...n){return new Promise((a,l)=>{this.finish.then(()=>{const h=this.transaction(this.libName,"readwrite").objectStore(this.libName)[e](...n);if(h.toString()==="[object IDBIndex]"){a(h);return}h.onsuccess=o=>a(o.target.result),h.onerror=l})})}get(e){return this.dealRequest("get",e)}getAll(e){return this.dealRequest("getAll",e)}add(e){return this.dealRequest("add",_(O({},e),{create:Date.now()}))}async update(e){const n=await this.get(e.id);return this.dealRequest("put",_(O(O({},n),e),{update:Date.now()}))}delete(e){return this.dealRequest("delete",e)}find(e,n="content"){return new Promise(async(a,l)=>{const i=[],h=await this.dealRequest("index",n);if(!e){h.getAll().onsuccess=g=>a(g.target.result);return}const o=IDBKeyRange.only(e);h.openCursor(o).onsuccess=g=>{const I=g.target.result;if(!I)return a(i);i.push(I.value),I.continue()}})}query(e,n="content"){return new Promise(async(a,l)=>{try{const i=await this.dealRequest("index",n);i.getAll().onsuccess=h=>{const o=h.target.result;if(!e)return a(o);const g=e.split(" ").filter(w=>w),I=o.filter(w=>{const v=w[n]+"";for(let S=0;S<g.length;S++)if(!v.includes(g[S]))return!1;let c=new RegExp(`(.{0,10})(${g.reverse().join("|")})(.{0,10})`,"g");const m=v.replace(c,'$%$1<span class="searchHight">$2</span>$3%$').match(/(?<=\$%)(.*?)(?=%\$)/g,"$1");return w.__searchResult=m,!0});a(I)}}catch(i){console.error(i),a([])}})}}const le=["create","update"],at={storeName:"atom",index:[...le,"title:false","content","describe","type","area","target","tag","history","extra"]},nt={storeName:"relation",index:[...le,"childId","parentId","relation","target","area"]},st={storeName:"tag",index:[...le,"atomId","title","content","describe","color","type","target"]},rt={dbName:"waterMelon",dbVersion:4,storeList:[at,nt,st]};var Fe=new tt(rt);class ot{constructor(){K(this,"_finish",null);K(this,"dbList",["atom","tag","relation"]);K(this,"data",q({atom:[],tag:[],relation:[],currentItem:{}}));K(this,"dbItem",{atom:null,tag:null,relation:null});this.initDb(),this._finish=this.init()}async initDb(){for(let e in this.dbItem)this.dbItem[e]=await Fe.getLib(e)}async init(e="atom"){if(e){const a=await Fe.getLib(e).getAll();return this.data[e]=a}const n=await Promise.all(this.dbList.map(a=>this.dbList[a].getAll()));return this.dbList.forEach((a,l)=>this.data[a]=n[l]),n}async atomFetch(e,...n){const a=await this.dbItem.atom[e](...n);return await this.init("atom"),a}async tagFetch(e,...n){const a=await this.dbItem.tag[e](...n);return await this.init("tag"),a}async relationFetch(e,...n){const a=await this.dbItem.relation[e](...n);return await this.init("relation"),a}changeData(e,n){this.data[e]&&(this.data[e]=n)}}const xe=new ot;window.libFetch=xe;var it={emits:["mousedownFnc"],setup(d,{emit:e,slots:n}){return()=>p("div",{class:"dragPanel",onSelect:()=>!1,onMousedown:fe(a=>e("mousedownFnc",a),["self"])},[n.default&&n.default()])}},Se={props:{area:Object,layer:Number,fullScreen:{type:Boolean,default:!1}},emits:["changeTile"],setup(d,{slots:e,emit:n,expose:a}){const{area:l,layer:i,fullScreen:h}=V(d),o=q({top:0,left:0,width:0,height:0});i.value=i.value||0;const g=(L,y)=>{const x=0,k=10,j=window.innerWidth-o.width,H=window.innerHeight-o.height||k;o.left=Math.max(x,Math.min(j,L)),o.top=Math.min(H,Math.max(k,y))},I=()=>{var L,y,x,k;o.width=((L=l.value)==null?void 0:L.width)||c.value&&c.value.getBoundingClientRect().width||0,o.height=((y=l.value)==null?void 0:y.height)||c.value&&c.value.getBoundingClientRect().height||0,g(((x=l.value)==null?void 0:x.left)||0,Math.max(((k=l.value)==null?void 0:k.top)||0,14))},w=C(!1);w.value=h.value;const v=C(!1),c=C(null),m=C(null),S=C(0),D=C(0),M=C(0),P=re("zIndex"),T=re("upperLayer");M.value=P.value;const r=()=>{T(),M.value=P.value},R=(L,y)=>{if(w.value){w.value=!1,v.value=!1;return}if(v.value=!0,!c.value)return;const{left:x,top:k}=c.value.getBoundingClientRect();S.value=L.clientX-x,D.value=L.clientY-k,r()},u=L=>v.value=!1,s=L=>{if(!v.value)return;let y=L.clientX-S.value,x=L.clientY-D.value;g(y,x)},F=L=>w.value=!w.value;return I(),A(()=>o,L=>{w.value||n("changeTile",L)},{deep:!0}),A(()=>l.value,I,{deep:!0}),U(()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",u),document.addEventListener("mousemove",s),document.addEventListener("mouseup",u),new ResizeObserver(y=>{let{width:x,height:k}=y[0].contentRect;x===0||k===0||w.value||(Math.abs(x-o.width)>2||Math.abs(k-o.height)>2)&&(o.width=x,o.height=k)}).observe(m.value)}),a({changeScreen:F,changeIndex:r}),()=>p("div",{ref:c,style:{left:o.left+"px",top:o.top+"px","z-index":M.value},class:{tile:!0,fullScreen:!!w.value}},[p(it,{onMousedownFnc:R},{default:()=>[e.header&&e.header(o,{changeIndex:r,changeScreen:F,isFull:w,isHandler:v})]}),p("div",{ref:m},[e.default&&e.default(o,{changeIndex:r,isFull:w,isHandler:v})]),e.footer&&e.footer(o,{changeIndex:r})])}};G.setOptions({gfm:!0,tables:!0,breaks:!0,katex:!1,headerIds:!0,headerPrefix:"",highlight:function(d,e){const n=e?[e]:null;return He.highlightAuto(d,n).value}});const ct={checkbox(d,...e){return window.changeChecked=n=>{n.checked?n.setAttribute("checked","checked"):n.removeAttribute("checked")},`<input type="checkbox" ${d?"checked disabled":""} onChange="changeChecked(this)" /> `}};G.use({renderer:ct});const ee=new ge({headingStyle:"atx",codeBlockStyle:"fenced",bulletListMarker:"-",fence:"```",preformattedCode:!0});ge.prototype.escape=d=>[[/\\/g,"\\\\"],[/\*/g,"\\*"],[/^\+ /g,"\\+ "],[/^(#{1,6}) /g,"\\$1 "],[/`/g,"\\`"],[/^~~~/g,"\\~~~"],[/^>/g,"\\>"],[/^_/g,"\\_"]].reduce((n,a)=>n.replace(a[0],a[1]),d);ee.addRule("content_rule",{filter:["input"],replacement:(d,e,n)=>e.type==="checkbox"?e.checked?"[x]":"[ ]":d});ee.addRule("content_rule",{filter:["del"],replacement:(d,e,n)=>`~~${d}~~`});const Ce=ee.turndown.bind(ee),lt=d=>{const e=d.clipboardData.getData("text/html"),n=d.clipboardData.getData("text/plain"),l=window.getSelection().getRangeAt(0);l.deleteContents(),l.startContainer,l.startOffset;const i=G(Ce(e||n)),h=document.createElement("div");h.innerHTML=i,l.insertNode(h)};var ut={props:{content:String,viewSeat:Object,isFocus:{type:Boolean,default:!1},editAble:{type:Boolean,default:!1}},emits:["blurfnc","update:content"],setup(d,e){const{content:n,viewSeat:a,editAble:l,isFocus:i}=V(d),{emit:h}=e,o=C("view"),g=()=>{o.value&&h("blurfnc",{content:o.value.innerHTML},"view")},I=()=>{!o.value||(a.value.width&&(o.value.style.width=a.value.width+"px"),a.value.height&&(o.value.style.height=a.value.height+"px"))};return U(()=>{!o.value||(I(),i.value&&o.value.focus())}),me(g),()=>p("div",{ref:o,class:"view",contentEditable:l.value,innerHTML:n.value,onBlur:g,onSelect:()=>!1,onPaste:fe(lt,["stop","prevent"])},null)}};const dt={theme:"vs-dark",roundedSelection:!0,automaticLayout:!0,autoDetectHighContrast:!0,contextmenu:!0,lineNumbers:!1,droppable:!0,fontSize:15,fontFamily:'consolas, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif',format:!0,formatOnType:!0,formatOnPaste:!0,autoIndent:!0,folding:!0,wordWrap:!0,language:"markdown",charset:"UTF-8",unicodeHighlight:{invisibleCharacters:!1,ambiguousCharacters:!1},minimap:{enabled:!1}},ht=[{label:"bbb",kind:oe.CompletionItemKind.Tag,insertText:"\u9009\u62E9\u540E\u7C98\u8D34\u5230\u7F16\u8F91\u5668\u4E2D\u7684\u6587\u5B57",detail:"\u4EFB\u4F55\u6587\u5B57\u63D0\u793A",preselect:!0},{label:"aaa",kind:oe.CompletionItemKind.Function,insertText:"aaa",detail:"\u4EFB\u4F55\u6587\u5B57\u63D0\u793A123"}];oe.registerCompletionItemProvider("markdown",{autoIndent:!0,triggerCharacters:["#"],provideCompletionItems(d,e,...n){let a=[];return d.getWordAtPosition(e),window.mo=d,a=d.getLineContent(e.lineNumber).slice(e.column-2).startsWith("#")?[...ht]:[],{suggestions:JSON.parse(JSON.stringify(a))}}});class pt{constructor(e,{blur:n}){K(this,"monaco",null);const a=Ie.create(e,dt);return a.editor=Ie,a.onDidBlurEditorWidget(n),new qe().activate(a),a}}var vt={props:{content:String,viewSeat:Object,metaData:Object},emits:["blurfnc","update:content"],setup(d,e){const{content:n,viewSeat:a,metaData:l}=V(d),{emit:i}=e,h=C("editor");let o=null;const g=()=>{if(!o)return;const v=o.getValue()||"",c=v.replace(/===\n([\s\S]*)\n===\n/g,""),m=/===\n([\s\S]*)\n===\n/g.exec(v)&&/===\n([\s\S]*)\n===\n/g.exec(v)[1];let S=null;if(m){const D=/title:\s*(.*)\n/.exec(m);console.dir(D);let M=D&&D[1];const P=/describe:(.*)\n|describe:(.*)$/.exec(m),T=P&&(P[2]||P[1])||"",r=/^[\s\n\r]*#{1,}\s(.*)\n/.exec(c);M=r&&r[1]||M||"",S={title:M.trim(),describe:T.trim()}}return{content:c,metaData:S}},I=()=>{i("blurfnc",g(),"editor")},w=()=>{h.value.style.width=a.value.width+"px",h.value.style.height=a.value.height+"px"};return U(()=>{w(),o=new pt(h.value,{blur:I});const v=`===
 title: ${l.value.title}
 describe: ${l.value.describe}
===
${n.value}`;o.setValue(v),o.focus()}),me(I),()=>p("div",{class:"editor",ref:h},null)}},ft={props:["itemInfo","itemIndex","layer","viewModel","isFocus","isActive","pageItem"],emits:["deleteItem","add","changeLayer","changeCurrent","changePage","hide","mark"],setup(d,{emit:e,expose:n}){const a=C(null),{itemInfo:l,itemIndex:i,layer:h,viewModel:o,isFocus:g,isActive:I,pageItem:w}=V(d),v=C(""),c=C(!1),m=C({title:"",describe:""});c.value=g.value,v.value=l.value.content||"",m.value.title=l.value.title||"",m.value.describe=l.value.describe||"";const S=C(!0);S.value=o.value;const D=C({}),M=ie(()=>G(v.value)),P=ie(()=>v.value),T=(s,F,L)=>{let y=F==="view"?Ce(s.content):s.content;if(y=y.replace(/[-]\s{2,}/g,"- "),y=y.trim(),!v.value&&!y&&!l.value.id){if(L)return;e("deleteItem",i.value)}v.value=y,m.value=s.metaData||m.value},r=s=>a.value&&a.value.changeScreen(s),R=s=>a.value&&a.value.changeIndex(),u=s=>{D.value=s,e("changeLayer",{area:s,content:v.value},i.value)};return A(()=>v.value+m.value.title+m.value.describe,s=>{console.dir(s),e("add",_(O({content:v.value},m.value),{area:O(O({},l.value.area),D.value)}),i.value)}),n({triggleView:s=>{S.value=!S.value,c.value=!0},changeScreen:r,changeIndex:R,isView:S}),()=>p(Se,{ref:a,area:l.value.area,layer:h.value,class:_(O({},l.value.options),{active:I.value}),onMouseup:s=>s.target.className.includes("dragPanel")&&e("changeCurrent",-1),onMousedown:()=>e("changeCurrent",i.value),onChangeTile:u},{header:()=>{var s,F;return p("span",{class:"toolPanel"},[!((F=(s=l.value)==null?void 0:s.options)==null?void 0:F.searchLink)&&p("span",{class:"tool pin",title:"Pin Up",onClick:L=>e("hide",i.value,"pin")},null),p("span",{class:"tool mark",title:"Mark It",onClick:L=>e("mark",i.value)},null),p("span",{class:"tool hide",title:"Hide It",onClick:L=>e("hide",i.value,"hide")},null)])},default:(s,{isFull:F,isHandler:L,changeIndex:y})=>p("div",{style:"positon: relative;"},[p("span",{class:{cardBefore:!0,active:I.value},onClick:x=>e("changePage",i.value)},[l.value.id]),S.value?p(ut,{class:{fullScreen:F.value},content:M.value,"onUpdate:content":x=>M.value=x,viewSeat:s,isFocus:c.value,onBlurfnc:(...x)=>T(...x,L.value),onMousedown:y,editAble:!0},null):p(vt,{class:{fullScreen:F.value},content:P.value,"onUpdate:content":x=>P.value=x,viewSeat:s,onMousedown:y,editAble:!0,metaData:m.value,onBlurfnc:(...x)=>T(...x,L.value)},null)])})}};var gt={name:"Search",props:["area","isShow"],setup(d,{emit:e}){const a=Q().appContext.config.globalProperties.$libFetch,l=a.data;window.libData=l;const{isShow:i,area:h}=V(d),o=C(""),g=C(null),I=C([]),w=async(v,{self:c,current:m})=>{if(c||m)return;const S=await a.atomFetch("get",v);S&&e("insertFnc",S),o.value="",i.value=!1};return U(()=>{document.addEventListener("keydown",v=>{v.code==="Escape"&&i.value&&(o.value="",i.value=!1)})}),A(()=>i.value,v=>{v&&setTimeout(()=>{g.value.focus()},50)}),A(()=>o.value,async v=>{const c={t:"title",c:"content",d:"describe"};let[m="",S="content",D="atom"]=v.trim().split("|");if(m=m.trim(),S=S.trim(),S=c[S]||S,!m)return I.value=[];I.value=await a[D+"Fetch"]("query",m,S)||[],console.dir(m),console.dir(S),console.dir(I.value),console.dir("--------------------")}),()=>p(Se,{style:{display:i.value?"block":"none"},area:h.value},{default:v=>p("div",{class:"searchPanel"},[be(p("input",{ref:g,type:"text",class:"searchIcon","onUpdate:modelValue":c=>o.value=c},null),[[we,o.value]]),p("div",{class:"searchResult"},[I.value.map(c=>{const m=c.id===l.currentItem.id,S=c.parentIds&&c.parentIds.includes(`%${l.currentItem.id}$`);return p("div",{class:"searchItem",onClick:()=>w(c.id,{self:m,current:S})},[p("div",{class:"itemHeader"},[p("div",{class:{light:!0,current:S,self:m}},[z("\xA0")]),p("div",null,[p("div",null,[c.title||c.content.substr(0,18)])])])])})])])})}};var mt={props:["currentItem","menuList","activeIndex","isShow"],emits:["showCard","changePage"],setup(d,{emit:e}){const{menuList:n,currentItem:a,activeIndex:l,isShow:i}=V(d);console.dir(a);const h=o=>{let g=o.title||"";const I=o.content||"",w=o.describe||"";g||(g=I.replace(/[^\w]/g,"").slice(0,10));const v=`[${o.id}] ${g}`;return w?`${v} (${w})`:v};return()=>p("div",{class:{menuPanel:!0,showMenu:i.value}},[p("div",{class:"parent",title:h(a.value)},[p("span",null,[h(a.value)])]),n.value.map((o,g)=>{var I;return p("div",{onClick:w=>{if(w.altKey)return e("changePage",g);e("showCard",g)},class:{searchLink:!!((I=o==null?void 0:o.options)==null?void 0:I.searchLink),active:l.value===g,hide:o.target===".hide"},title:h(o)},[p("span",null,[h(o)])])})])}};var It={props:["toPanel","currentItem"],emits:["hideInsert","insert"],setup(d,{expose:e,emit:n}){const{toPanel:a,currentItem:l}=V(d),h=Q().appContext.config.globalProperties.$libFetch,o=C(null),g=C(null),I=C(""),w=C(!1),v=C([]),c=C([]),m=q({left:0,top:0,width:300,height:300}),S=r=>{I.value="",v.value=[],w.value=!1,n("hideInsert")},D=async r=>{if(r.key==="Escape")return S();if(r.code==="Enter"&&r.altKey){const R=a.value==="tag"?"tagFetch":"atomFetch",u=I.value.trim(),s=await h[R]("add",{content:u,title:u}),F=await h[R]("get",s-0);n("insert",F)}},M=async(r,R)=>{n("insert",R)},P=()=>{const{left:r}=o.value.getBoundingClientRect(),{height:R}=g.value.getBoundingClientRect();m.left=r,m.top=window.innerHeight-25-R,console.dir(m.top)},T=async()=>{I.value="",setTimeout(()=>{o.value&&o.value.focus()},50);const r=a.value==="tag"?"tagFetch":"atomFetch",R=await h[r]("getAll");c.value=R,v.value=R,setTimeout(()=>{P()},50),w.value=!0};return U(()=>{T()}),A(()=>a.value,T),A(()=>I.value,async r=>{const R={t:"title",c:"content",d:"describe"},u=a.value==="tag"?"tagFetch":"atomFetch";let[s="",F="c"]=r.split("|");if(s=s.trim(),F=F.trim(),F=R[F]||"content",s)if(isNaN(s-0))v.value=c.value.filter(y=>y[F].includes(s));else{const y=await h[u]("get",s-0);v.value=y?[y]:[]}else v.value=c.value;setTimeout(()=>{P()},50),w.value=!!v.value.length}),()=>p(ce,null,[p(ye,{to:"#"+a.value},{default:()=>[be(p("input",{ref:o,type:"text",class:"suggestInput","onUpdate:modelValue":r=>I.value=r,onKeyup:D},null),[[we,I.value]])]}),p(ye,{to:"body"},{default:()=>[p("div",{ref:g,class:{suggestResult:!0,showResult:w.value},style:{left:m.left+"px",top:m.top+"px"}},[p("div",null,[v.value.map(r=>p("div",{onClick:R=>M(R,r),title:r.content},[r.title||r.describe||r.content.slice(0,10),z(" - "),r.id]))])])]})])}},bt={name:"Tape",props:{pageData:{type:Object,default(){return{}}},currentIndex:{type:Number,default:0}},setup(d,{expose:e}){const n=Le(),{pageData:a,currentIndex:l}=V(d),h=Q().appContext.config.globalProperties.$libFetch,o=async u=>h.atomFetch("get",u),g=C(null),I=C(!1),w=C(""),v=C({}),c=q({id:"",title:"",describe:"",parentIds:[],childIds:[],tagList:[],parentIdMap:{},childIdMap:{}}),m=re("insertCard"),S=ie(()=>{const u=c.id,s=c.title||c.describe||"";return s?u+"_"+s:u}),D=()=>{I.value=!1,w.value=""},M=(u,s)=>{u.target.className.includes("metaItem")||w.value!==s&&(I.value=!0,w.value=s)},P=()=>{c.id="",c.parentIds=[],c.childIds=[],c.tagList=[],c.parentIdMap={},c.childIdMap={}},T=async()=>{const u=a.value.pageList[l.value]||a.value.currentItem;v.value=u;const{id:s}=u;if(!s)return;P(),c.id=s;const[F,L,y,x]=await Promise.all([h.relationFetch("find",s,"parentId"),h.relationFetch("find",s,"childId"),h.tagFetch("getAll"),h.atomFetch("get",s)]);c.title=x.title,c.describe=x.describe,y.forEach(k=>{k.atomId&&k.atomId.includes(s)&&c.tagList.push(k)}),L.forEach(async k=>{const j=k.parentId,H=await o(j);c.parentIdMap[k.parentId]=k.id,c.parentIds.push({id:j,item:k,atom:H})}),F.map(async k=>{const j=k.childId;c.childIdMap[k.childId]=k.id;const H=await o(j);c.childIds.push({id:j,item:k,atom:H})})},r=async u=>{const s=v.value.id,F=u.id-0;if(s===F)return;const L=w.value;if(L==="tag"){const y=await h.tagFetch("get",F),x=y.atomId||[];if(x.includes(s))return;x.push(s);const k=_(O({},y),{atomId:x});await h.tagFetch("update",k),c.tagList.push(k)}else{const y=L==="parent"?"childId":"parentId";if(c[L+"IdMap"][F])return;const x={[y]:s,[L+"Id"]:F};await h.relationFetch("add",x),c[L+"Ids"].push({id:F,item:x,atom:u}),c[L+"IdMap"][F]=s}D()},R=async(u,s,F)=>{const L=v.value.id;let y;if(u.ctrlKey&&u.shiftKey){if(F==="tag"){y=s.id;const k=(s.atomId||[]).filter(j=>j!==L);await h.tagFetch("update",{id:y,atomId:k})}else y=s.item.id,await h.relationFetch("delete",y);return T()}else if(u.altKey){let x="";return s.atom&&(x+=s.atom.title?"#"+s.atom.title:"",x+=s.atom.describe?"#"+s.atom.describe:""),n.push({name:F==="tag"?"tag":"ov",params:{id:s.id},hash:x})}else u.ctrlKey&&m(s.atom);console.dir(u)};return A(()=>l.value,T),A(()=>a.value.currentItem.id,T),e({hideInsert:D}),()=>p(ce,null,[p("div",{id:"tape",class:"tape"},[p("div",{class:"info"},[p("span",{class:"metaInfo"},[p("span",null,[S.value])]),p("span",{id:"parent",onClick:u=>M(u,"parent")},[p("span",{class:"itemTitle"},[z("P")]),c.parentIds.map(u=>{const s=u.atom.title||u.atom.describe,F=s?"_"+s:"";return p("span",{class:{metaItem:!0,current:u.id===a.value.currentItem.id},title:u.atom.title||u.atom.describe||u.atom.content,onClick:L=>R(L,u)},[u.id+F])})]),p("span",{id:"child",onClick:u=>M(u,"child")},[p("span",{class:"itemTitle"},[z("C")]),c.childIds.map(u=>{const s=u.atom.title||u.atom.describe,F=s?"_"+s:"";return p("span",{class:{metaItem:!0,current:u.id===a.value.currentItem.id},title:u.atom.title||u.atom.describe||u.atom.content,onClick:L=>R(L,u)},[u.id+F])})]),p("span",{id:"tag",onClick:u=>M(u,"tag")},[p("span",{class:"itemTitle"},[z("T")]),c.tagList.map(u=>p("span",{class:{metaItem:!0},title:u.title||u.content,style:{color:u.color||""},onClick:s=>R(s,u,"tag")},[u.content||u.id]))])])]),I.value&&p(It,{ref:g,onInsert:r,toPanel:w,currentItem:v,onHideInsert:D},null)])}},wt={setup(d,e){const n=Ue(),a=Le(),i=Q().appContext.config.globalProperties.$libFetch,h=i.data,o=q({}),g=C(0),I=C(-1),w=C(!0),v=C(null),c=C(!1),m=C(""),S=C(0),D=C(!0),M=C(!1),P=C(null),T=q({left:1e4,top:14,right:0,width:580,height:"auto",zIndex:9999}),r=q({currentItem:{},pageList:[],pageIdsList:{},atomList:[],relationItem:[]}),R=async(t,b)=>{const f=h.atom.find($=>$.title===b);if(f)return f;const N=await i.atomFetch("add",{title:b,type:t,describe:b});return await i.atomFetch("get",N)},u=async t=>{if(await i._finish,t==="root"){const f=await R(".root",t);return r.currentItem=f}if(t-=0,isNaN(t))return;const b=h.atom.find(f=>f.id===t);if(!b)return a.push({name:"ov",params:{id:"root"},hash:"#root"});r.currentItem=b},s=t=>{const{id:b,title:f,describe:N}=r.pageList[t];let B=f?"#"+f:"";B+=N?"#"+N:"",b&&a.push({name:"ov",params:{id:b},hash:B})},F=()=>{r.pageList=r.atomList.filter(({target:t})=>t!==".del"),w.value=!0},L=async()=>{const t=r.currentItem;i.changeData("currentItem",t);const b=[],f=await i.relationFetch("find",t.id,"parentId");await Promise.all(f.map(async({childId:N="",area:B,target:$})=>{const E=await i.atomFetch("get",N);return b.push(_(O({},E),{key:Math.random().toString(16),area:B,target:$,hide:$===".hide"})),E})),r.atomList=b,r.relationItem=f,F()},y=t=>I.value=t-0,x=(t,b)=>{const f=r.pageList.push(_(O({key:Math.random().toString(16)},t),{options:b}));y(f-1)},k=t=>{const b=r.pageIdsList[t.id];if(b||b===0){y(b),r.pageList[b].hide=!1;return}x(O({},t),{searchLink:!0})},j=t=>{k(t),c.value=!1},H=(t={})=>c.value=!0,ke=t=>{t.target===t.currentTarget&&(P.value&&P.value.hideInsert(),y(-1),!!(t.ctrlKey||t.altKey)&&(t.preventDefault(),x({area:{left:t.pageX,top:t.pageY}},{isFocus:!0,ignoreParent:t.shiftKey}),w.value=t.ctrlKey))},de=async(t,b)=>{const f=r.pageList[b],$=f,{options:N={}}=$,B=Z($,["options"]);if(B.id){if(await i.atomFetch("update",JSON.parse(JSON.stringify(_(O({},t),{id:B.id})))),!N.searchLink){const E=r.relationItem.find(({childId:X})=>X===B.id);E&&await i.relationFetch("update",JSON.parse(JSON.stringify({id:E.id,area:t.area})))}}else{const E=await i.atomFetch("add",JSON.parse(JSON.stringify(t)));if(r.pageList[b].id=E,!(N==null?void 0:N.ignoreParent)){const X={childId:E,parentId:r.currentItem.id,area:t.area},Oe=await i.relationFetch("add",X);r.relationItem.push(O({id:Oe},X))}}f.content=t.content||f.content,f.area=t.area||f.area},te=async t=>{await u(t),L()},De=async({area:t,content:b},f)=>{!r.pageList[f]||!r.pageList[f].id||de({area:t,content:b},f)},Me=()=>S.value=S.value+1,J=async(t,b)=>{const f=r.pageList.splice(t,1)[0];if(!(!f||!f.id))if(b)await i.atomFetch("update",{id:f.id,target:".del",delTime:Date.now()});else{await i.atomFetch("delete",f.id);const N=await i.relationFetch("find",f.id,"childId");[...await i.relationFetch("find",f.id,"parentId"),...N].forEach(({id:E})=>i.relationFetch("delete",E))}},Re=async t=>{const b=r.pageList[t];console.dir(b)},he=async(t,b)=>{var $;const f=r.pageList[t],N=f.target===".hide"?"":".hide";if(b==="hide")return(($=f==null?void 0:f.options)==null?void 0:$.searchLink)&&r.pageList.splice(t,1),f.hide=!0;const B=r.relationItem.find(E=>E.childId===f.id);await i.relationFetch("update",{id:B.id,target:N}),f.target=N,f.hide=N===".hide"},Ne=()=>{r.pageList.forEach(t=>{t.target!==".hide"&&(t.hide=D.value)}),D.value=!D.value},Pe=()=>{r.pageList.forEach(async t=>{const b=r.relationItem.find(f=>f.childId===t.id);await i.relationFetch("update",{id:b.id,target:".hide"}),t.target=".hide",t.hide=!0})},Te=t=>{const b=r.pageList[t];y(t),b.hide=!1};return W("insertCard",k),W("refreshHash",m),W("refreshFnc",()=>m.value=Math.random().toString(16)),W("upperLayer",Me),W("zIndex",S),U(()=>{te(n.params.id),document.onkeydown=t=>{const b=t.srcElement.localName==="body",f=I.value;if(b)return t.code==="KeyX"?window.close():t.code==="KeyP"?H():t.code==="KeyR"?te(n.params.id):t.code==="KeyM"?M.value=!M.value:t.code==="KeyH"&&t.altKey&&t.shiftKey?Pe():t.code==="KeyH"&&t.altKey?Ne():(t.code==="Minus"&&t.ctrlKey&&(t.preventDefault(),history.go(-1)),t.code==="Equal"&&t.ctrlKey&&(t.preventDefault(),history.go(1)),f===-1?void 0:t.ctrlKey&&t.shiftKey&&t.code==="Delete"?J(f):t.altKey&&t.code==="Delete"?J(f,30):void 0);const N=o[f];if(N&&t.altKey&&t.code==="KeyV")return N.triggleView(t);if(N&&t.altKey&&t.code==="KeyZ")return N.changeScreen(t);if(t.altKey&&t.code==="KeyH")return he(f,"pin");if(t.altKey&&t.code==="Delete")return J(f)}}),A(()=>n.params.id,t=>t&&te(t)),A(()=>r.pageList.length,t=>{r.pageIdsList=[],r.pageList.forEach((b,f)=>{r.pageIdsList[b.id]=f,g.value=Math.max(g.value,t)}),g.value=Math.max(g.value,t)},{deep:!0}),A(()=>I.value,t=>{const b=o[t];b&&b.changeIndex()}),()=>p(ce,null,[p(mt,{menuList:r.pageList,currentItem:r.currentItem,activeIndex:I.value,isShow:M.value,onShowCard:Te,onChangePage:s},null),p("div",{style:"width: calc(100vw - 15px); height: calc(100vh);",ref:v,onclick:ke},[p(gt,{isShow:c,area:T,onInsertFnc:j},null),r.pageList.map((t,b)=>{var f;return!t.hide&&p(ft,{key:t.key,ref:N=>o[b]=N,viewModel:w,pageItem:r.currentItem,itemInfo:t,itemIndex:b,layer:g.value,isActive:I.value===b,isFocus:((f=t==null?void 0:t.options)==null?void 0:f.isFocus)||!1,onAdd:de,onChangeLayer:De,onChangeCurrent:y,onDeleteItem:J,onChangePage:s,onMark:Re,onHide:he},null)}),p(bt,{ref:P,currentIndex:I,pageData:r},null)])])}};const yt=ze({history:We(),routes:[{name:"ov",path:"/ov/:id",component:wt},{path:"/:pathMatch(.*)*",redirect:"/ov/root"}]}),ue=Je(et);ue.config.globalProperties.$libFetch=xe;ue.use(yt);ue.mount("#app");const Lt=Ye({onNeedRefresh(){},onOfflineReady(){}});Lt();
