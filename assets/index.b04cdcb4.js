var Be=Object.defineProperty,Ee=Object.defineProperties;var Ke=Object.getOwnPropertyDescriptors;var Y=Object.getOwnPropertySymbols;var pe=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var te=(d,e,n)=>e in d?Be(d,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):d[e]=n,O=(d,e)=>{for(var n in e||(e={}))pe.call(e,n)&&te(d,n,e[n]);if(Y)for(var n of Y(e))ve.call(e,n)&&te(d,n,e[n]);return d},_=(d,e)=>Ee(d,Ke(e));var Z=(d,e)=>{var n={};for(var a in d)pe.call(d,a)&&e.indexOf(a)<0&&(n[a]=d[a]);if(d!=null&&Y)for(var a of Y(d))e.indexOf(a)<0&&ve.call(d,a)&&(n[a]=d[a]);return n};var B=(d,e,n)=>(te(d,typeof e!="symbol"?e+"":e,n),n);import{v as je,r as Ae,c as ae,w as $e,o as ne,K as _e,a as Ve,b as q,d as p,e as fe,t as V,f as C,i as se,g as j,h as U,m as G,l as He,T as ge,j as me,k as re,n as Ie,M as qe,p as oe,q as Q,s as be,u as we,x as z,F as ie,y as ye,z as Le,A as Ue,B as W,C as ze,D as We,E as Je}from"./vendor.ddf52c42.js";const Xe=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))a(l);new MutationObserver(l=>{for(const c of l)if(c.type==="childList")for(const h of c.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&a(h)}).observe(document,{childList:!0,subtree:!0});function n(l){const c={};return l.integrity&&(c.integrity=l.integrity),l.referrerpolicy&&(c.referrerPolicy=l.referrerpolicy),l.crossorigin==="use-credentials"?c.credentials="include":l.crossorigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(l){if(l.ep)return;l.ep=!0;const c=n(l);fetch(l.href,c)}};Xe();function Ye(d={}){const{immediate:e=!1,onNeedRefresh:n,onOfflineReady:a,onRegistered:l,onRegisterError:c}=d;let h;const o=async(m=!0)=>{};return"serviceWorker"in navigator&&(h=new je("/sw.js",{scope:"/",type:"classic"}),h.addEventListener("activated",m=>{m.isUpdate?window.location.reload():a==null||a()}),h.register({immediate:e}).then(m=>{l==null||l(m)}).catch(m=>{c==null||c(m)})),o}var Ze=(d,e)=>{const n=d.__vccOpts||d;for(const[a,l]of e)n[a]=l;return n};const Ge={};function Qe(d,e){const n=Ae("router-view");return ne(),ae(n,null,{default:$e(({Component:a})=>[(ne(),ae(_e,null,[(ne(),ae(Ve(a)))],1024))]),_:1})}var et=Ze(Ge,[["render",Qe]]);class tt{constructor(e){B(this,"idbDataBase",null);B(this,"transaction",null);B(this,"request",null);B(this,"runner",[]);B(this,"storeList",[]);B(this,"finish",null);B(this,"libName","");B(this,"operateLib",null);this.init(e)}init(c){var h=c,{dbName:e="waterMelon",dbVersion:n="1",storeList:a=[]}=h,l=Z(h,["dbName","dbVersion","storeList"]);this.dbName=e,this.idbDataBase&&this.idbDataBase.close(),this.finish=new Promise((o,m)=>{const I=i=>{const g=i.target.result;this.idbDataBase=g,this.dbVersion=g.version,this.idbObjectStoreNames=g.objectStoreNames,window.dataBase=g,this.transaction=this.idbDataBase.transaction.bind(this.idbDataBase),o(g)},y=i=>{I(i);const g=[];a.forEach(P=>{var T=P,{index:D}=T,M=Z(T,["index"]);let r=null;g.push(M.storeName),this.idbObjectStoreNames.contains(M.storeName)?r=this.request.transaction.objectStore(M.storeName):r=this.idbDataBase.createObjectStore(M.storeName,O({keyPath:"id",autoIncrement:!0},M)),[...r.indexNames].forEach(u=>r.deleteIndex(u)),D.forEach(u=>{let[s,F="false"]=u.split(":");s=s.trim(),F=F.trim(),r.createIndex(s,s,{unique:F!=="false"})})}),[...this.idbDataBase.objectStoreNames].forEach(D=>{g.includes(D)||this.idbDataBase.deleteObjectStore(D)})},v=indexedDB.open(e,n);v.onupgradeneeded=i=>y(i),v.onsuccess=i=>I(i),v.onerror=m,this.request=v})}close(){this.idbDataBase&&this.idbDataBase.close()}getLib(e){const n=Object.create(this);return n.libName=e,n}dealRequest(e,...n){return new Promise((a,l)=>{this.finish.then(()=>{const h=this.transaction(this.libName,"readwrite").objectStore(this.libName)[e](...n);if(h.toString()==="[object IDBIndex]"){a(h);return}h.onsuccess=o=>a(o.target.result),h.onerror=l})})}get(e){return this.dealRequest("get",e)}getAll(e){return this.dealRequest("getAll",e)}add(e){return this.dealRequest("add",_(O({},e),{create:Date.now()}))}async update(e){const n=await this.get(e.id);return this.dealRequest("put",_(O(O({},n),e),{update:Date.now()}))}delete(e){return this.dealRequest("delete",e)}find(e,n="content"){return new Promise(async(a,l)=>{const c=[],h=await this.dealRequest("index",n);if(!e){h.getAll().onsuccess=m=>a(m.target.result);return}const o=IDBKeyRange.only(e);h.openCursor(o).onsuccess=m=>{const I=m.target.result;if(!I)return a(c);c.push(I.value),I.continue()}})}query(e,n="content"){return new Promise(async(a,l)=>{try{const c=await this.dealRequest("index",n);c.getAll().onsuccess=h=>{const o=h.target.result;if(!e)return a(o);const m=e.split(" ").filter(y=>y),I=o.filter(y=>{const v=y[n]+"";for(let S=0;S<m.length;S++)if(!v.includes(m[S]))return!1;let i=new RegExp(`(.{0,10})(${m.reverse().join("|")})(.{0,10})`,"g");const g=v.replace(i,'$%$1<span class="searchHight">$2</span>$3%$').match(/(?<=\$%)(.*?)(?=%\$)/g,"$1");return y.__searchResult=g,!0});a(I)}}catch(c){console.error(c),a([])}})}}const ce=["create","update"],at={storeName:"atom",index:[...ce,"title:false","content","describe","type","area","target","tag","history","extra"]},nt={storeName:"relation",index:[...ce,"childId","parentId","relation","target","area"]},st={storeName:"tag",index:[...ce,"atomId","title","content","describe","color","type","target"]},rt={dbName:"waterMelon",dbVersion:4,storeList:[at,nt,st]};var Fe=new tt(rt);class ot{constructor(){B(this,"_finish",null);B(this,"dbList",["atom","tag","relation"]);B(this,"data",q({atom:[],tag:[],relation:[],currentItem:{}}));B(this,"dbItem",{atom:null,tag:null,relation:null});this.initDb(),this._finish=this.init()}async initDb(){for(let e in this.dbItem)this.dbItem[e]=await Fe.getLib(e)}async init(e="atom"){if(e){const a=await Fe.getLib(e).getAll();return this.data[e]=a}const n=await Promise.all(this.dbList.map(a=>this.dbList[a].getAll()));return this.dbList.forEach((a,l)=>this.data[a]=n[l]),n}async atomFetch(e,...n){const a=await this.dbItem.atom[e](...n);return await this.init("atom"),a}async tagFetch(e,...n){const a=await this.dbItem.tag[e](...n);return await this.init("tag"),a}async relationFetch(e,...n){const a=await this.dbItem.relation[e](...n);return await this.init("relation"),a}changeData(e,n){this.data[e]&&(this.data[e]=n)}}const xe=new ot;window.libFetch=xe;var it={emits:["mousedownFnc"],setup(d,{emit:e,slots:n}){return()=>p("div",{class:"dragPanel",onSelect:()=>!1,onMousedown:fe(a=>e("mousedownFnc",a),["self"])},[n.default&&n.default()])}},Se={props:{area:Object,layer:Number,fullScreen:{type:Boolean,default:!1}},emits:["changeTile"],setup(d,{slots:e,emit:n,expose:a}){const{area:l,layer:c,fullScreen:h}=V(d),o=q({top:0,left:0,width:0,height:0});c.value=c.value||0;const m=(L,w)=>{const x=0,k=10,A=window.innerWidth-o.width,H=window.innerHeight-o.height||k;o.left=Math.max(x,Math.min(A,L)),o.top=Math.min(H,Math.max(k,w))},I=()=>{var L,w,x,k;o.width=((L=l.value)==null?void 0:L.width)||i.value&&i.value.getBoundingClientRect().width||0,o.height=((w=l.value)==null?void 0:w.height)||i.value&&i.value.getBoundingClientRect().height||0,m(((x=l.value)==null?void 0:x.left)||0,Math.max(((k=l.value)==null?void 0:k.top)||0,14))},y=C(!1);y.value=h.value;const v=C(!1),i=C(null),g=C(null),S=C(0),D=C(0),M=C(0),P=se("zIndex"),T=se("upperLayer");M.value=P.value;const r=()=>{T(),M.value=P.value},R=(L,w)=>{if(y.value){y.value=!1,v.value=!1;return}if(v.value=!0,!i.value)return;const{left:x,top:k}=i.value.getBoundingClientRect();S.value=L.clientX-x,D.value=L.clientY-k,r()},u=L=>v.value=!1,s=L=>{if(!v.value)return;let w=L.clientX-S.value,x=L.clientY-D.value;m(w,x)},F=L=>y.value=!y.value;return I(),j(()=>o,L=>{y.value||n("changeTile",L)},{deep:!0}),j(()=>l.value,I,{deep:!0}),U(()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",u),document.addEventListener("mousemove",s),document.addEventListener("mouseup",u),new ResizeObserver(w=>{let{width:x,height:k}=w[0].contentRect;x===0||k===0||y.value||(Math.abs(x-o.width)>2||Math.abs(k-o.height)>2)&&(o.width=x,o.height=k)}).observe(g.value)}),a({changeScreen:F,changeIndex:r}),()=>p("div",{ref:i,style:{left:o.left+"px",top:o.top+"px","z-index":M.value},class:{tile:!0,fullScreen:!!y.value}},[p(it,{onMousedownFnc:R},{default:()=>[e.header&&e.header(o,{changeIndex:r,changeScreen:F,isFull:y,isHandler:v})]}),p("div",{ref:g},[e.default&&e.default(o,{changeIndex:r,isFull:y,isHandler:v})]),e.footer&&e.footer(o,{changeIndex:r})])}};G.setOptions({gfm:!0,tables:!0,breaks:!0,katex:!1,headerIds:!0,headerPrefix:"",highlight:function(d,e){const n=e?[e]:null;return He.highlightAuto(d,n).value}});const ct={checkbox(d,...e){return window.changeChecked=n=>{n.checked?n.setAttribute("checked","checked"):n.removeAttribute("checked")},`<input type="checkbox" ${d?"checked disabled":""} onChange="changeChecked(this)" /> `}};G.use({renderer:ct});const le=new ge({headingStyle:"atx",codeBlockStyle:"fenced",bulletListMarker:"-",fence:"```",preformattedCode:!0});ge.prototype.escape=d=>[[/\\/g,"\\\\"],[/\*/g,"\\*"],[/^\+ /g,"\\+ "],[/^(#{1,6}) /g,"\\$1 "],[/`/g,"\\`"],[/^~~~/g,"\\~~~"],[/^>/g,"\\>"],[/^_/g,"\\_"]].reduce((n,a)=>n.replace(a[0],a[1]),d);le.addRule("content_rule",{filter:["input"],replacement:(d,e,n)=>e.type==="checkbox"?e.checked?"[x]":"[ ]":d});const Ce=le.turndown.bind(le),lt=d=>{const e=d.clipboardData.getData("text/html"),n=d.clipboardData.getData("text/plain"),l=window.getSelection().getRangeAt(0);l.deleteContents(),l.startContainer,l.startOffset;const c=G(Ce(e||n)),h=document.createElement("div");h.innerHTML=c,l.insertNode(h)};var ut={props:{content:String,viewSeat:Object,isFocus:{type:Boolean,default:!1},editAble:{type:Boolean,default:!1}},emits:["blurfnc","update:content"],setup(d,e){const{content:n,viewSeat:a,editAble:l,isFocus:c}=V(d),{emit:h}=e,o=C("view"),m=()=>{o.value&&h("blurfnc",{content:o.value.innerHTML},"view")},I=()=>{!o.value||(a.value.width&&(o.value.style.width=a.value.width+"px"),a.value.height&&(o.value.style.height=a.value.height+"px"))};return U(()=>{!o.value||(I(),c.value&&o.value.focus())}),me(m),()=>p("div",{ref:o,class:"view",contentEditable:l.value,innerHTML:n.value,onBlur:m,onSelect:()=>!1,onPaste:fe(lt,["stop","prevent"])},null)}};const dt={theme:"vs-dark",roundedSelection:!0,automaticLayout:!0,autoDetectHighContrast:!0,contextmenu:!0,lineNumbers:!1,droppable:!0,fontSize:15,fontFamily:'consolas, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif',format:!0,formatOnType:!0,formatOnPaste:!0,autoIndent:!0,folding:!0,wordWrap:!0,language:"markdown",charset:"UTF-8",unicodeHighlight:{invisibleCharacters:!1,ambiguousCharacters:!1},minimap:{enabled:!1}},ht=[{label:"bbb",kind:re.CompletionItemKind.Tag,insertText:"\u9009\u62E9\u540E\u7C98\u8D34\u5230\u7F16\u8F91\u5668\u4E2D\u7684\u6587\u5B57",detail:"\u4EFB\u4F55\u6587\u5B57\u63D0\u793A",preselect:!0},{label:"aaa",kind:re.CompletionItemKind.Function,insertText:"aaa",detail:"\u4EFB\u4F55\u6587\u5B57\u63D0\u793A123"}];re.registerCompletionItemProvider("markdown",{autoIndent:!0,triggerCharacters:["#"],provideCompletionItems(d,e,...n){let a=[];return d.getWordAtPosition(e),window.mo=d,a=d.getLineContent(e.lineNumber).slice(e.column-2).startsWith("#")?[...ht]:[],{suggestions:JSON.parse(JSON.stringify(a))}}});class pt{constructor(e,{blur:n}){B(this,"monaco",null);const a=Ie.create(e,dt);return a.editor=Ie,a.onDidBlurEditorWidget(n),new qe().activate(a),a}}var vt={props:{content:String,viewSeat:Object,metaData:Object},emits:["blurfnc","update:content"],setup(d,e){const{content:n,viewSeat:a,metaData:l}=V(d),{emit:c}=e,h=C("editor");let o=null;const m=()=>{if(!o)return;const v=o.getValue()||"",i=v.replace(/===\n([\s\S]*)\n===\n/g,""),g=/===\n([\s\S]*)\n===\n/g.exec(v)&&/===\n([\s\S]*)\n===\n/g.exec(v)[1];let S=null;if(g){const D=/title:\s*(.*)\n/.exec(g);console.dir(D);let M=D&&D[1];const P=/describe:(.*)\n|describe:(.*)$/.exec(g),T=P&&(P[2]||P[1])||"",r=/^[\s\n\r]*#{1,}\s(.*)\n/.exec(i);M=r&&r[1]||M||"",S={title:M.trim(),describe:T.trim()}}return{content:i,metaData:S}},I=()=>{c("blurfnc",m(),"editor")},y=()=>{h.value.style.width=a.value.width+"px",h.value.style.height=a.value.height+"px"};return U(()=>{y(),o=new pt(h.value,{blur:I});const v=`===
 title: ${l.value.title}
 describe: ${l.value.describe}
===
${n.value}`;o.setValue(v),o.focus()}),me(I),()=>p("div",{class:"editor",ref:h},null)}},ft={props:["itemInfo","itemIndex","layer","viewModel","isFocus","isActive","pageItem"],emits:["deleteItem","add","changeLayer","changeCurrent","changePage","hide","mark"],setup(d,{emit:e,expose:n}){const a=C(null),{itemInfo:l,itemIndex:c,layer:h,viewModel:o,isFocus:m,isActive:I,pageItem:y}=V(d),v=C(""),i=C(!1),g=C({title:"",describe:""});i.value=m.value,v.value=l.value.content||"",g.value.title=l.value.title||"",g.value.describe=l.value.describe||"";const S=C(!0);S.value=o.value;const D=C({}),M=oe(()=>G(v.value)),P=oe(()=>v.value),T=(s,F,L)=>{let w=F==="view"?Ce(s.content):s.content;if(w=w.replace(/[-]\s{2,}/g,"- "),w=w.trim(),!v.value&&!w&&!l.value.id){if(L)return;e("deleteItem",c.value)}v.value=w,g.value=s.metaData||g.value},r=s=>a.value&&a.value.changeScreen(s),R=s=>a.value&&a.value.changeIndex(),u=s=>{D.value=s,e("changeLayer",{area:s,content:v.value},c.value)};return j(()=>v.value+g.value.title+g.value.describe,s=>{console.dir(s),e("add",_(O({content:v.value},g.value),{area:O(O({},l.value.area),D.value)}),c.value)}),n({triggleView:s=>{S.value=!S.value,i.value=!0},changeScreen:r,changeIndex:R,isView:S}),()=>p(Se,{ref:a,area:l.value.area,layer:h.value,class:_(O({},l.value.options),{active:I.value}),onMouseup:s=>s.target.className.includes("dragPanel")&&e("changeCurrent",-1),onMousedown:()=>e("changeCurrent",c.value),onChangeTile:u},{header:()=>{var s,F;return p("span",{class:"toolPanel"},[!((F=(s=l.value)==null?void 0:s.options)==null?void 0:F.searchLink)&&p("span",{class:"tool pin",title:"Pin Up",onClick:L=>e("hide",c.value,"pin")},null),p("span",{class:"tool mark",title:"Mark It",onClick:L=>e("mark",c.value)},null),p("span",{class:"tool hide",title:"Hide It",onClick:L=>e("hide",c.value,"hide")},null)])},default:(s,{isFull:F,isHandler:L,changeIndex:w})=>p("div",{style:"positon: relative;"},[p("span",{class:{cardBefore:!0,active:I.value},onClick:x=>e("changePage",c.value)},[l.value.id]),S.value?p(ut,{class:{fullScreen:F.value},content:M.value,"onUpdate:content":x=>M.value=x,viewSeat:s,isFocus:i.value,onBlurfnc:(...x)=>T(...x,L.value),onMousedown:w,editAble:!0},null):p(vt,{class:{fullScreen:F.value},content:P.value,"onUpdate:content":x=>P.value=x,viewSeat:s,onMousedown:w,editAble:!0,metaData:g.value,onBlurfnc:(...x)=>T(...x,L.value)},null)])})}};var gt={name:"Search",props:["area","isShow"],setup(d,{emit:e}){const a=Q().appContext.config.globalProperties.$libFetch,l=a.data;window.libData=l;const{isShow:c,area:h}=V(d),o=C(""),m=C(null),I=C([]),y=async(v,{self:i,current:g})=>{if(i||g)return;const S=await a.atomFetch("get",v);S&&e("insertFnc",S),o.value="",c.value=!1};return U(()=>{document.addEventListener("keydown",v=>{v.code==="Escape"&&c.value&&(o.value="",c.value=!1)})}),j(()=>c.value,v=>{v&&setTimeout(()=>{m.value.focus()},50)}),j(()=>o.value,async v=>{const i={t:"title",c:"content",d:"describe"};let[g="",S="content",D="atom"]=v.trim().split("|");if(g=g.trim(),S=S.trim(),S=i[S]||S,!g)return I.value=[];I.value=await a[D+"Fetch"]("query",g,S)||[],console.dir(g),console.dir(S),console.dir(I.value),console.dir("--------------------")}),()=>p(Se,{style:{display:c.value?"block":"none"},area:h.value},{default:v=>p("div",{class:"searchPanel"},[be(p("input",{ref:m,type:"text",class:"searchIcon","onUpdate:modelValue":i=>o.value=i},null),[[we,o.value]]),p("div",{class:"searchResult"},[I.value.map(i=>{const g=i.id===l.currentItem.id,S=i.parentIds&&i.parentIds.includes(`%${l.currentItem.id}$`);return p("div",{class:"searchItem",onClick:()=>y(i.id,{self:g,current:S})},[p("div",{class:"itemHeader"},[p("div",{class:{light:!0,current:S,self:g}},[z("\xA0")]),p("div",null,[p("div",null,[i.title||i.content.substr(0,18)])])])])})])])})}};var mt={props:["currentItem","menuList","activeIndex","isShow"],emits:["showCard"],setup(d,{emit:e}){const{menuList:n,currentItem:a,activeIndex:l,isShow:c}=V(d);console.dir(a);const h=o=>{let m=o.title||"";const I=o.content||"",y=o.describe||"";m||(m=I.replace(/[^\w]/g,"").slice(0,10));const v=`[${o.id}] ${m}`;return y?`${v} (${y})`:v};return()=>p("div",{class:{menuPanel:!0,showMenu:c.value}},[p("div",{class:"parent",title:h(a.value)},[p("span",null,[h(a.value)])]),n.value.map((o,m)=>{var I;return p("div",{onClick:y=>e("showCard",m),class:{searchLink:!!((I=o==null?void 0:o.options)==null?void 0:I.searchLink),active:l.value===m,hide:o.target===".hide"},title:h(o)},[p("span",null,[h(o)])])})])}};var It={props:["toPanel","currentItem"],emits:["hideInsert","insert"],setup(d,{expose:e,emit:n}){const{toPanel:a,currentItem:l}=V(d),h=Q().appContext.config.globalProperties.$libFetch,o=C(null),m=C(null),I=C(""),y=C(!1),v=C([]),i=C([]),g=q({left:0,top:0,width:300,height:300}),S=r=>{I.value="",v.value=[],y.value=!1,n("hideInsert")},D=async r=>{if(r.key==="Escape")return S();if(r.code==="Enter"&&r.altKey){const R=a.value==="tag"?"tagFetch":"atomFetch",u=I.value.trim(),s=await h[R]("add",{content:u,title:u}),F=await h[R]("get",s-0);n("insert",F)}},M=async(r,R)=>{n("insert",R)},P=()=>{const{left:r}=o.value.getBoundingClientRect(),{height:R}=m.value.getBoundingClientRect();g.left=r,g.top=window.innerHeight-25-R,console.dir(g.top)},T=async()=>{I.value="",setTimeout(()=>{o.value&&o.value.focus()},50);const r=a.value==="tag"?"tagFetch":"atomFetch",R=await h[r]("getAll");i.value=R,v.value=R,setTimeout(()=>{P()},50),y.value=!0};return U(()=>{T()}),j(()=>a.value,T),j(()=>I.value,async r=>{const R={t:"title",c:"content",d:"describe"},u=a.value==="tag"?"tagFetch":"atomFetch";let[s="",F="c"]=r.split("|");if(s=s.trim(),F=F.trim(),F=R[F]||"content",s)if(isNaN(s-0))v.value=i.value.filter(w=>w[F].includes(s));else{const w=await h[u]("get",s-0);v.value=w?[w]:[]}else v.value=i.value;setTimeout(()=>{P()},50),y.value=!!v.value.length}),()=>p(ie,null,[p(ye,{to:"#"+a.value},{default:()=>[be(p("input",{ref:o,type:"text",class:"suggestInput","onUpdate:modelValue":r=>I.value=r,onKeyup:D},null),[[we,I.value]])]}),p(ye,{to:"body"},{default:()=>[p("div",{ref:m,class:{suggestResult:!0,showResult:y.value},style:{left:g.left+"px",top:g.top+"px"}},[p("div",null,[v.value.map(r=>p("div",{onClick:R=>M(R,r),title:r.content},[r.title||r.describe||r.content.slice(0,10),z(" - "),r.id]))])])]})])}},bt={name:"Tape",props:{pageData:{type:Object,default(){return{}}},currentIndex:{type:Number,default:0}},setup(d,{expose:e}){const n=Le(),{pageData:a,currentIndex:l}=V(d),h=Q().appContext.config.globalProperties.$libFetch,o=async u=>h.atomFetch("get",u),m=C(null),I=C(!1),y=C(""),v=C({}),i=q({id:"",title:"",describe:"",parentIds:[],childIds:[],tagList:[],parentIdMap:{},childIdMap:{}}),g=se("insertCard"),S=oe(()=>{const u=i.id,s=i.title||i.describe||"";return s?u+"_"+s:u}),D=()=>{I.value=!1,y.value=""},M=(u,s)=>{u.target.className.includes("metaItem")||y.value!==s&&(I.value=!0,y.value=s)},P=()=>{i.id="",i.parentIds=[],i.childIds=[],i.tagList=[],i.parentIdMap={},i.childIdMap={}},T=async()=>{const u=a.value.pageList[l.value]||a.value.currentItem;v.value=u;const{id:s}=u;if(!s)return;P(),i.id=s;const[F,L,w,x]=await Promise.all([h.relationFetch("find",s,"parentId"),h.relationFetch("find",s,"childId"),h.tagFetch("getAll"),h.atomFetch("get",s)]);i.title=x.title,i.describe=x.describe,w.forEach(k=>{k.atomId&&k.atomId.includes(s)&&i.tagList.push(k)}),L.forEach(async k=>{const A=k.parentId,H=await o(A);i.parentIdMap[k.parentId]=k.id,i.parentIds.push({id:A,item:k,atom:H})}),F.map(async k=>{const A=k.childId;i.childIdMap[k.childId]=k.id;const H=await o(A);i.childIds.push({id:A,item:k,atom:H})})},r=async u=>{const s=v.value.id,F=u.id-0;if(s===F)return;const L=y.value;if(L==="tag"){const w=await h.tagFetch("get",F),x=w.atomId||[];if(x.includes(s))return;x.push(s);const k=_(O({},w),{atomId:x});await h.tagFetch("update",k),i.tagList.push(k)}else{const w=L==="parent"?"childId":"parentId";if(i[L+"IdMap"][F])return;const x={[w]:s,[L+"Id"]:F};await h.relationFetch("add",x),i[L+"Ids"].push({id:F,item:x,atom:u}),i[L+"IdMap"][F]=s}D()},R=async(u,s,F)=>{const L=v.value.id;let w;if(u.ctrlKey&&u.shiftKey){if(F==="tag"){w=s.id;const k=(s.atomId||[]).filter(A=>A!==L);await h.tagFetch("update",{id:w,atomId:k})}else w=s.item.id,await h.relationFetch("delete",w);return T()}else if(u.altKey){let x="";return s.atom&&(x+=s.atom.title?"#"+s.atom.title:"",x+=s.atom.describe?"#"+s.atom.describe:""),n.push({name:F==="tag"?"tag":"ov",params:{id:s.id},hash:x})}else u.ctrlKey&&g(s.atom);console.dir(u)};return j(()=>l.value,T),j(()=>a.value.currentItem.id,T),e({hideInsert:D}),()=>p(ie,null,[p("div",{id:"tape",class:"tape"},[p("div",{class:"info"},[p("span",{class:"metaInfo"},[p("span",null,[S.value])]),p("span",{id:"parent",onClick:u=>M(u,"parent")},[p("span",{class:"itemTitle"},[z("P")]),i.parentIds.map(u=>{const s=u.atom.title||u.atom.describe,F=s?"_"+s:"";return p("span",{class:{metaItem:!0,current:u.id===a.value.currentItem.id},title:u.atom.title||u.atom.describe||u.atom.content,onClick:L=>R(L,u)},[u.id+F])})]),p("span",{id:"child",onClick:u=>M(u,"child")},[p("span",{class:"itemTitle"},[z("C")]),i.childIds.map(u=>{const s=u.atom.title||u.atom.describe,F=s?"_"+s:"";return p("span",{class:{metaItem:!0,current:u.id===a.value.currentItem.id},title:u.atom.title||u.atom.describe||u.atom.content,onClick:L=>R(L,u)},[u.id+F])})]),p("span",{id:"tag",onClick:u=>M(u,"tag")},[p("span",{class:"itemTitle"},[z("T")]),i.tagList.map(u=>p("span",{class:{metaItem:!0},title:u.title||u.content,style:{color:u.color||""},onClick:s=>R(s,u,"tag")},[u.content||u.id]))])])]),I.value&&p(It,{ref:m,onInsert:r,toPanel:y,currentItem:v,onHideInsert:D},null)])}},wt={setup(d,e){const n=Ue(),a=Le(),c=Q().appContext.config.globalProperties.$libFetch,h=c.data,o=q({}),m=C(0),I=C(-1),y=C(!0),v=C(null),i=C(!1),g=C(""),S=C(0),D=C(!0),M=C(!1),P=C(null),T=q({left:1e4,top:14,right:0,width:580,height:"auto",zIndex:9999}),r=q({currentItem:{},pageList:[],pageIdsList:{},atomList:[],relationItem:[]}),R=async(t,b)=>{const f=h.atom.find($=>$.title===b);if(f)return f;const N=await c.atomFetch("add",{title:b,type:t,describe:b});return await c.atomFetch("get",N)},u=async t=>{if(await c._finish,t==="root"){const f=await R(".root",t);return r.currentItem=f}if(t-=0,isNaN(t))return;const b=h.atom.find(f=>f.id===t);if(!b)return a.push({name:"ov",params:{id:"root"},hash:"#root"});r.currentItem=b},s=t=>{const{id:b,title:f,describe:N}=r.pageList[t];let E=f?"#"+f:"";E+=N?"#"+N:"",b&&a.push({name:"ov",params:{id:b},hash:E})},F=()=>{r.pageList=r.atomList.filter(({target:t})=>t!==".del"),y.value=!0},L=async()=>{const t=r.currentItem;c.changeData("currentItem",t);const b=[],f=await c.relationFetch("find",t.id,"parentId");await Promise.all(f.map(async({childId:N="",area:E,target:$})=>{const K=await c.atomFetch("get",N);return b.push(_(O({},K),{key:Math.random().toString(16),area:E,target:$,hide:$===".hide"})),K})),r.atomList=b,r.relationItem=f,F()},w=t=>I.value=t-0,x=(t,b)=>{const f=r.pageList.push(_(O({key:Math.random().toString(16)},t),{options:b}));w(f-1)},k=t=>{const b=r.pageIdsList[t.id];if(b||b===0){w(b),r.pageList[b].hide=!1;return}x(O({},t),{searchLink:!0})},A=t=>{k(t),i.value=!1},H=(t={})=>i.value=!0,ke=t=>{t.target===t.currentTarget&&(P.value&&P.value.hideInsert(),w(-1),!!(t.ctrlKey||t.altKey)&&(t.preventDefault(),x({area:{left:t.pageX,top:t.pageY}},{isFocus:!0,ignoreParent:t.shiftKey}),y.value=t.ctrlKey))},de=async(t,b)=>{const f=r.pageList[b],$=f,{options:N={}}=$,E=Z($,["options"]);if(E.id){if(await c.atomFetch("update",JSON.parse(JSON.stringify(_(O({},t),{id:E.id})))),!N.searchLink){const K=r.relationItem.find(({childId:X})=>X===E.id);K&&await c.relationFetch("update",JSON.parse(JSON.stringify({id:K.id,area:t.area})))}}else{const K=await c.atomFetch("add",JSON.parse(JSON.stringify(t)));if(r.pageList[b].id=K,!(N==null?void 0:N.ignoreParent)){const X={childId:K,parentId:r.currentItem.id,area:t.area},Oe=await c.relationFetch("add",X);r.relationItem.push(O({id:Oe},X))}}f.content=t.content||f.content,f.area=t.area||f.area},ee=async t=>{await u(t),L()},De=async({area:t,content:b},f)=>{!r.pageList[f]||!r.pageList[f].id||de({area:t,content:b},f)},Me=()=>S.value=S.value+1,J=async(t,b)=>{const f=r.pageList.splice(t,1)[0];if(!(!f||!f.id))if(b)await c.atomFetch("update",{id:f.id,target:".del",delTime:Date.now()});else{await c.atomFetch("delete",f.id);const N=await c.relationFetch("find",f.id,"childId");[...await c.relationFetch("find",f.id,"parentId"),...N].forEach(({id:K})=>c.relationFetch("delete",K))}},Re=async t=>{const b=r.pageList[t];console.dir(b)},he=async(t,b)=>{var $;const f=r.pageList[t],N=f.target===".hide"?"":".hide";if(b==="hide")return(($=f==null?void 0:f.options)==null?void 0:$.searchLink)&&r.pageList.splice(t,1),f.hide=!0;const E=r.relationItem.find(K=>K.childId===f.id);await c.relationFetch("update",{id:E.id,target:N}),f.target=N,f.hide=N===".hide"},Ne=()=>{r.pageList.forEach(t=>{t.target!==".hide"&&(t.hide=D.value)}),D.value=!D.value},Pe=()=>{r.pageList.forEach(t=>{}),D.value=!D.value},Te=t=>{const b=r.pageList[t];w(t),b.hide=!1};return W("insertCard",k),W("refreshHash",g),W("refreshFnc",()=>g.value=Math.random().toString(16)),W("upperLayer",Me),W("zIndex",S),U(()=>{ee(n.params.id),document.onkeydown=t=>{const b=t.srcElement.localName==="body",f=I.value;if(b)return t.code==="KeyX"?window.close():t.code==="KeyP"?H():t.code==="KeyR"?ee(n.params.id):t.code==="KeyM"?M.value=!M.value:t.code==="KeyH"&&t.altKey?Ne():t.code==="KeyH"&&t.ctrlKey?Pe():(t.code==="Minus"&&t.ctrlKey&&(t.preventDefault(),history.go(-1)),t.code==="Equal"&&t.ctrlKey&&(t.preventDefault(),history.go(1)),f===-1?void 0:t.ctrlKey&&t.shiftKey&&t.code==="Delete"?J(f):t.altKey&&t.code==="Delete"?J(f,30):void 0);const N=o[f];if(N&&t.altKey&&t.code==="KeyV")return N.triggleView(t);if(N&&t.altKey&&t.code==="KeyZ")return N.changeScreen(t);if(t.altKey&&t.code==="KeyH")return he(f,"pin");if(t.altKey&&t.code==="Delete")return J(f)}}),j(()=>n.params.id,t=>t&&ee(t)),j(()=>r.pageList.length,t=>{r.pageIdsList=[],r.pageList.forEach((b,f)=>{r.pageIdsList[b.id]=f,m.value=Math.max(m.value,t)}),m.value=Math.max(m.value,t)},{deep:!0}),j(()=>I.value,t=>{const b=o[t];b&&b.changeIndex()}),()=>p(ie,null,[p(mt,{menuList:r.pageList,currentItem:r.currentItem,activeIndex:I.value,isShow:M.value,onShowCard:Te},null),p("div",{style:"width: calc(100vw - 15px); height: calc(100vh);",ref:v,onclick:ke},[p(gt,{isShow:i,area:T,onInsertFnc:A},null),r.pageList.map((t,b)=>{var f;return!t.hide&&p(ft,{key:t.key,ref:N=>o[b]=N,viewModel:y,pageItem:r.currentItem,itemInfo:t,itemIndex:b,layer:m.value,isActive:I.value===b,isFocus:((f=t==null?void 0:t.options)==null?void 0:f.isFocus)||!1,onAdd:de,onChangeLayer:De,onChangeCurrent:w,onDeleteItem:J,onChangePage:s,onMark:Re,onHide:he},null)}),p(bt,{ref:P,currentIndex:I,pageData:r},null)])])}};const yt=ze({history:We(),routes:[{name:"ov",path:"/ov/:id",component:wt},{path:"/:pathMatch(.*)*",redirect:"/ov/root"}]}),ue=Je(et);ue.config.globalProperties.$libFetch=xe;ue.use(yt);ue.mount("#app");const Lt=Ye({onNeedRefresh(){},onOfflineReady(){}});Lt();
