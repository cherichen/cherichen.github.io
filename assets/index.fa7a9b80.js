var W=Object.defineProperty,G=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var A=Object.prototype.hasOwnProperty,T=Object.prototype.propertyIsEnumerable;var E=(s,e,n)=>e in s?W(s,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[e]=n,B=(s,e)=>{for(var n in e||(e={}))A.call(e,n)&&E(s,n,e[n]);if(j)for(var n of j(e))T.call(e,n)&&E(s,n,e[n]);return s},D=(s,e)=>G(s,J(e));var F=(s,e)=>{var n={};for(var t in s)A.call(s,t)&&e.indexOf(t)<0&&(n[t]=s[t]);if(s!=null&&j)for(var t of j(s))e.indexOf(t)<0&&T.call(s,t)&&(n[t]=s[t]);return n};var L=(s,e,n)=>(E(s,typeof e!="symbol"?e+"":e,n),n);import{c as v,w as P,t as R,r as z,a as S,b as C,o as O,m as q,l as Q,T as Z,d as V,e as $,f as _,g as ee,h as te,i as ne,j as ae,u as oe,F as re,k as se}from"./vendor.3f8817cc.js";const le=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))t(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function n(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerpolicy&&(l.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?l.credentials="include":a.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function t(a){if(a.ep)return;a.ep=!0;const l=n(a);fetch(a.href,l)}};le();var ie={emits:["mousedownFnc"],setup(s,{emit:e,slots:n}){const t=a=>e("mousedownFnc",a);return()=>v("div",{class:"dragPanel",onSelect:()=>!1,onMousedown:P(t,["self"])},[n.default&&n.default()])}},ce={props:{seat:Object,layer:Number,fullScreen:{type:Boolean,default:!1}},emits:["downFnc","upFnc","moveFnc","changeTile"],setup(s,{slots:e,attrs:n,emit:t}){const{seat:a,layer:l,fullScreen:r}=R(s),o=z({top:0,left:0,width:0,height:0,zIndex:0});o.top=Math.max(a.value.top,14),o.left=a.value.left,o.width=a.value.width,o.height=a.value.height,o.zIndex=a.value.zIndex||l.value;const i=S(!1);i.value=r.value;const f=S(!1),w=S(null),b=S(null),m=S(0),p=S(0),y=()=>{if(l.value<o.zIndex)return;const d=l.value+1;o.zIndex=d,t("changeTile",o)},u=(d,I)=>{if(i.value){i.value=!1,f.value=!1;return}if(f.value=!0,!w.value)return;const{left:N,top:x}=w.value.getBoundingClientRect();m.value=d.clientX-N,p.value=d.clientY-x,y(),t("downFnc",d)},c=d=>f.value=!1,h=d=>{if(!f.value)return;let I=d.clientX-m.value,N=d.clientY-p.value;const x=0,M=10,X=window.innerWidth-o.width,Y=window.innerHeight-o.height;o.left=Math.max(x,Math.min(X,I)),o.top=Math.min(Y,Math.max(M,N))},g=d=>i.value=!i.value;return C(o,d=>{i.value||t("changeTile",d)},{deep:!0}),O(()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",c),document.addEventListener("mousemove",h),document.addEventListener("mouseup",c),new ResizeObserver(I=>{let{width:N,height:x}=I[0].contentRect;o.width=N,o.height=x}).observe(b.value)}),()=>v("div",{ref:w,style:{left:o.left+"px",top:o.top+"px","z-index":o.zIndex},class:{tile:!0,fullScreen:!!i.value}},[v(ie,{onMousedownFnc:u},{default:()=>[e.dragHeader&&e.dragHeader(o,{upperLayer:y,changeScreen:g,isFull:i,isHandler:f})]}),e.header&&e.header(o),v("div",{ref:b},[e.default&&e.default(o,{upperLayer:y,isFull:i,isHandler:f})]),e.footer&&e.footer(o,{upperLayer:y})])}};q.setOptions({gfm:!0,tables:!0,breaks:!0,katex:!1,headerIds:!0,headerPrefix:"",highlight:function(s,e){const n=e?[e]:null;return Q.highlightAuto(s,n).value}});const H=new Z({headingStyle:"atx",codeBlockStyle:"fenced",fence:"```",preformattedCode:!0}),U=H.turndown.bind(H),ue=s=>{const e=s.clipboardData.getData("text/html"),n=s.clipboardData.getData("text/plain"),a=window.getSelection().getRangeAt(0);a.deleteContents(),a.startContainer,a.startOffset;const l=q(U(e||n)),r=document.createElement("div");r.innerHTML=l,a.insertNode(r)};var de={props:{content:String,viewSeat:Object,editAble:{type:Boolean,default:!1}},emits:["blurfnc","update:content"],setup(s,e){const{content:n,viewSeat:t,editAble:a}=R(s),{emit:l}=e,r=S("view"),o=()=>{l("blurfnc",r.value.innerHTML||"","view")},i=()=>{r.value.style.width=t.value.width+"px",r.value.style.height=t.value.height+"px"};return O(()=>{i(),r.value.focus()}),V(o),()=>v("div",{ref:r,class:"view",contentEditable:a.value,innerHTML:n.value,onBlur:o,onSelect:()=>!1,onPaste:P(ue,["stop","prevent"])},null)}};const fe={theme:"vs-dark",roundedSelection:!0,automaticLayout:!0,contextmenu:!0,lineNumbers:!1,droppable:!0,fontSize:15,fontFamily:'consolas, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif',format:!0,formatOnType:!0,formatOnPaste:!0,autoIndent:!0,wordWrap:!0,language:"markdown",minimap:{enabled:!1}};class he{constructor(e,{blur:n}){L(this,"monaco",null);const t=$.create(e,fe);return t.editor=$,t.onDidBlurEditorWidget(n),t}}var ve={props:{content:String,viewSeat:Object},emits:["blurfnc","update:content"],setup(s,e){const{content:n,viewSeat:t}=R(s),{emit:a}=e,l=S("editor");let r=null;const o=()=>{if(!!r)return r.getValue()||""},i=()=>a("blurfnc",o(),"editor"),f=()=>{l.value.style.width=t.value.width+"px",l.value.style.height=t.value.height+"px"};return O(()=>{f(),r=new he(l.value,{blur:i}),r.setValue(n.value),r.focus()}),V(i),()=>v("div",{class:"editor",ref:l},null)}},me={props:["itemInfo","itemIndex","layer","viewModel"],emits:["changeItem","add","changeLayer"],setup(s,{attrs:e,slots:n,emit:t}){const{itemInfo:a,itemIndex:l,layer:r,viewModel:o}=R(s),i=S("");i.value=a.value.content||"";const f=S(!0);f.value=o.value;const w=S({}),b=_(()=>q(i.value)),m=_(()=>i.value),p=c=>{w.value=c,t("changeLayer",B({},c),l.value)},y=(c,h,g)=>{let d=h==="view"?U(c):c;if(d=d.trim(),!i.value&&!d&&!a.value.atomId)return g?void 0:t("changeItem",l.value,".del");i.value=d},u=()=>t("changeItem",l.value,".keep");return C(i,c=>{t("add",{content:m.value,extra:B({},w.value)},l.value)}),()=>v(ce,{seat:a.value.seat,layer:r.value,onChangeTile:p},{dragHeader:(c,{changeScreen:h})=>v("div",null,[v("div",{class:"dragTitle"},[v("span",{class:"throwBox",onClick:u},null),v("span",{onClick:h},null),v("span",{onClick:()=>f.value=!f.value},null)])]),default:(c,{upperLayer:h,isFull:g,isHandler:d})=>v("div",null,[f.value?v(de,{class:{fullScreen:g.value},content:b.value,"onUpdate:content":I=>b.value=I,viewSeat:c,onBlurfnc:(...I)=>{y(...I,d.value)},onMousedown:h,editAble:!0},null):v(ve,{class:{fullScreen:g.value},content:m.value,"onUpdate:content":I=>m.value=I,viewSeat:c,onMousedown:h,editAble:!0,onBlurfnc:(...I)=>{y(...I,d.value)}},null)])})}},pe={setup(s,{attrs:e,slots:n}){const t=z([]),r=ee().appContext.config.globalProperties.$dbStore.getLib("atom"),o=S(null),i=S(0),f=S(!0),w=u=>{!(u.ctrlKey||u.altKey)||u.target===o.value&&(t.push({key:Math.random().toString(16),isNew:!0,seat:{left:u.pageX,top:u.pageY}}),f.value=u.altKey)},b=async u=>{r.update(u)},m=(u,c)=>{const h=t.splice(u,1),g=h[0]&&h[0].atomId;g&&b({target:c,id:g})},p=async(u,c)=>{const h=t[c];if(!h)return;if(h.atomId)return b(D(B({},u),{id:h.atomId}));const g=await r.add(u);h.atomId=g},y=(u,c)=>{i.value=u.zIndex,!(!t[c]||!t[c].atomId)&&p({extra:u},c)};return C(t,(u,c)=>{i.value=Math.max(i.value,t.length)}),O(async()=>{await r.finish;const u=await r.getAll(),c=[];u.forEach(h=>{const g={key:Math.random().toString(16),atomId:h.id,seat:h.extra,zIndex:h.zIndex,content:h.content};h.target===".keep"?c.push(g):t.push(g)})}),()=>v("div",{style:"width: calc(100vw); height: calc(100vh);",ref:o,onclick:w},[t.map((u,c)=>v(me,{key:u.key,itemInfo:u,itemIndex:c,layer:i.value,onChangeItem:m,onAdd:p,viewModel:f,onChangeLayer:y},null))])}};const ge={setup(s){return(e,n)=>{const t=te("router-view");return ne(),ae(re,null,[v(t),v(oe(pe))],64)}}};class be{constructor(e){L(this,"idbDataBase",null);L(this,"transaction",null);L(this,"request",null);L(this,"runner",[]);L(this,"storeList",[]);L(this,"finish",null);L(this,"libName","");L(this,"operateLib",null);this.init(e)}init(l){var r=l,{dbName:e="fireMelon",dbVersion:n="1",storeList:t=[]}=r,a=F(r,["dbName","dbVersion","storeList"]);this.dbName=e,this.idbDataBase&&this.idbDataBase.close(),this.finish=new Promise((o,i)=>{const f=m=>{const p=m.target.result;this.idbDataBase=p,this.dbVersion=p.version,this.idbObjectStoreNames=p.objectStoreNames,window.dataBase=p,this.transaction=this.idbDataBase.transaction.bind(this.idbDataBase),o(p)},w=m=>{f(m);const p=[];t.forEach(h=>{var g=h,{index:u}=g,c=F(g,["index"]);let d=null;p.push(c.storeName),this.idbObjectStoreNames.contains(c.storeName)?d=this.request.transaction.objectStore(c.storeName):d=this.idbDataBase.createObjectStore(c.storeName,B({keyPath:"id",autoIncrement:!0},c)),[...d.indexNames].forEach(N=>d.deleteIndex(N)),u.forEach(N=>{let[x,M="false"]=N.split(":");x=x.trim(),M=M.trim(),d.createIndex(x,x,{unique:M!=="false"})})}),[...this.idbDataBase.objectStoreNames].forEach(u=>{p.includes(u)||this.idbDataBase.deleteObjectStore(u)})},b=indexedDB.open(e,n);b.onupgradeneeded=m=>w(m),b.onsuccess=m=>f(m),b.onerror=i,this.request=b})}close(){this.idbDataBase&&this.idbDataBase.close()}getLib(e){const n=Object.create(this);return n.libName=e,n}dealRequest(e,...n){return new Promise((t,a)=>{this.finish.then(()=>{const r=this.transaction(this.libName,"readwrite").objectStore(this.libName)[e](...n);if(r.toString()==="[object IDBIndex]"){t(r);return}r.onsuccess=o=>t(o.target.result),r.onerror=a})})}get(e){return this.dealRequest("get",e)}getAll(e){return this.dealRequest("getAll",e)}add(e){return this.dealRequest("add",D(B({},e),{create:Date.now()}))}async update(e){const n=await this.get(e.id);return this.dealRequest("put",D(B(B({},n),e),{update:Date.now()}))}delete(e){return this.dealRequest("delete",e)}findOnly(e,n="content"){return new Promise(async(t,a)=>{const l=[],r=await this.dealRequest("index",n);if(!e){r.getAll().onsuccess=i=>t(i.target.result);return}const o=IDBKeyRange.only(e);r.openCursor(o).onsuccess=i=>{const f=i.target.result;if(!f)return t(result);l.push(f.value),f.continue()}})}query(e,n="content"){return new Promise(async(t,a)=>{const l=await this.dealRequest("index",n);l.getAll().onsuccess=r=>{const o=r.target.result;if(!e)return t(o);const i=e.split(" ").filter(w=>w),f=o.filter(w=>{const b=w[n];for(let y=0;y<i.length;y++)if(!b.includes(i[y]))return!1;let m=new RegExp(`(.{0,5})(${i.reverse().join("|")})(.{0,5})`,"g");const p=b.replace(m,'$%$1<span class="searchHight">$2</span>$3%$').match(/(?<=\$%)(.*?)(?=%\$)/g,"$1");return w.__searchResult=p,!0});t(f)}})}}const k=["create","update"],we={storeName:"atom",index:[...k,"title","content","sketch","addition","describe","type","target"]},ye={storeName:"paper",index:[...k,"atom","children","parent","type"]},Se={storeName:"tag",index:[...k,"title","content","children"]},Ie={storeName:"decorate",index:[...k,"atom","tag"]},xe={dbName:"waterMelon",dbVersion:13,storeList:[we,ye,Se,Ie]};var Le=new be(xe);const K=se(ge);K.config.globalProperties.$dbStore=Le;K.mount("#app");
